<!doctype html>
<html lang="en">


<head>
    <title>东方金工平台</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            /* needed for container min-height */
        }
        /* 表格的风格变成东方的风格 */
        /* 斑马条纹 */
        
        [id*="Multi"] tr:nth-child(even) {
            background-color: #c2c0bb4d;
        }
        /* 表头变成黑白 */
        
        [id*="Multi"] th {
            background-color: #8d8c89;
            color: white
        }
        /* 可以在容器内滚动 */
        
        .tab-content {
            height: 600px;
            overflow: auto;
            text-align: center
        }
        /* 雷达图的最小高度 */
        
        .radar {
            min-height: 400px;
        }
        /* link变成金色 */
        
        [id*="Multi"] a.nav-item.nav-link {
            color: #DAA620
        }
        
        nav a {
            color: #DAA620
        }
        
        #fofinfo_app nav li {
            background-color: #DAA620;
        }
        
        #fofinfo_app nav li a {
            color: white;
        }
        /* 输入栏聚焦时变成金色 */
        
        .form-control:focus {
            border-color: #DAA620;
            box-shadow: 0 0 0 0.2rem rgba(218, 207, 58, 0.671);
        }
        
        h4 {
            vertical-align: middle
        }
    </style>

    <link id="bsdp-css" href="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker3.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.2/dist/bootstrap-table.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.dark.min.css" integrity="sha512-nc1pKg6wCivxMCLNT7Intf8DfGGN34QbjjU/5hLixwYHzAofenG0KxhbCAZS/oYibU37I/OR/FUgyY+Kd7zE1g==" crossorigin="anonymous" />

    <script src="https://assets.pyecharts.org/assets/echarts.min.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js" integrity="sha512-90vH1Z83AJY9DmlWa8WkjkV79yfS2n2Oxhsi2dZbIv0nC4E6m5AbH8Nh156kkM7JePmqD6tcZsfad1ueoaovww==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/locales/bootstrap-datepicker.zh-CN.min.js" charset="UTF-8"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js" integrity="sha512-qzgd5cYSZcosqpzpn7zF2ZId8f/8CHmFKZ8j7mU4OUXTNRd5g+ZHBPsgKEwoqxCtdQvExE5LprwwPAgoicguNg==" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/bootstrap-table@1.18.2/dist/bootstrap-table.min.js"></script>
    <script src="https://kit.fontawesome.com/03973ac8c1.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script>
    <!-- <script src="func.js"></script> -->
    <script>
        // 全局变量
        let sqlStatement, bindDB, renderFunc, sqlBindList, tmp;
        let factorInfoAll, stockProductInfoAll, stockManagerInfoAll, bondProductInfoAll, bondManagerInfoAll;

        window.isAuthenticated = false;

        // 全局常量
        const industries = ['银行', '非银行金融or综合金融', '医药', '电子元器件or电子', '食品饮料',
            '房地产', '机械', '基础化工', '电力及公用事业', '汽车', '计算机', '家电', '有色金属',
            '建筑', '交通运输', '电力设备or电力设备及新能源', '传媒', '通信', '商贸零售', '农林牧渔',
            '建材', '钢铁', '国防军工', '石油石化', '轻工制造', '煤炭', '纺织服装', '餐饮旅游or消费者服务', '综合'
        ]
        const industry_labels = ['银行', '非银金融', '医药', '电子', '食品饮料',
            '房地产', '机械', '基础化工', '电力及公用事业', '汽车', '计算机', '家电', '有色金属',
            '建筑', '交通运输', '电力设备', '传媒', '通信', '商贸零售', '农林牧渔',
            '建材', '钢铁', '国防军工', '石油石化', '轻工制造', '煤炭', '纺织服装', '餐饮旅游', '综合'
        ]
        const universes = ['沪深300', '中证1000', '中证500', '中证800', '中证全指'];
        // groupid的映射
        const groupidMap = {
            1: '普通股票型基金',
            2: '偏股混合型基金',
            3: "平衡混合型基金",
            4: "灵活配置型基金",
            5: "偏债混合型基金",
            6: "普通股票型基金+偏股混合型基金",
            7: "主动权益基金",
            8: "中长期纯债型基金",
            9: "短期纯债型基金",
            10: "混合债券型基金",
        }

        // 提取返回多个query
        const postSQLs = (sqlBindList) => {
                return $.post(
                    // 'http://127.0.0.1:5000/',
                    'http://139.196.77.199:80', {
                        'sqlBindList': JSON.stringify(sqlBindList),
                        'user': window.inputUser
                    }
                )
            }
            // 提取返回单个query
        const postRender = (sqlStatement, bindDB, renderFunc) => {
            $.post(
                // 'http://127.0.0.1:5000',
                'http://139.196.77.199:80/', {
                    'sql': sqlStatement,
                    'bind': bindDB
                },
                renderFunc
            );
        }

        $(
            () => {

                // auth_app factorinfo_app fofinfo_app
                showApp('auth_app');
                // single_factor_dashboard multi_factor_recent multi_factor_interval
                // fofinfo_stock_product fofinfo_stock_manager fofinfo_bond_product fofinfo_bond_manager fofinfo_portfolio_track
                showSubApp("single_factor_dashboard")

                // 登录
                $('#inputPassword').keypress(function(event) {
                    if (event.key === "Enter") {
                        login();
                    }
                });
                $('#loginBtn').on('click', function(event) {
                    login();
                });

                // 把日期的输入变成datepicker的插件
                $('.input-group.date').datepicker({
                    language: "zh-CN",
                    todayBtn: "linked"
                });

                $('[id*="Multi"] table').tablesorter({
                    sortMultiSortKey: "shiftKey", // The key used to select more than one column for multi-column sorting.
                    sortInitialOrder: "desc", // starting sort direction "asc" or "desc"
                });

                // fof每页的tab表
                initTabTable(['基金业绩表现', '基金重仓股分析', '选基因子打分', '基金评价', '风险暴露', '行业暴露'], 'stockProductMulti');
                initTabTable(['基金经理业绩表现', '基金经理评价', '基金经理风险暴露', '基金经理行业暴露'], 'stockManagerMulti');
                initTabTable(['基金业绩表现', '基金评价（收益均为年化值）', '基金风格暴露', '全市场风格暴露中位数'], 'bondProductMulti');
                initTabTable(['基金经理业绩表现', '基金评价（收益均为年化值）', '基金风格暴露', '全市场风格暴露中位数'], 'bondManagerMulti')




                sqlBindList = [{
                    sql: 'select * from factorInfo',
                    bind: 'dfquant'
                }, {
                    sql: 'select * from fundinfo',
                    bind: 'fund'
                }, {
                    sql: 'select * from managerinfo',
                    bind: 'fund'
                }, {
                    sql: 'select * from fundinfo',
                    bind: 'fund_bond'
                }, {
                    sql: 'select * from managerinfo',
                    bind: 'fund_bond'
                }]
                postSQLs(sqlBindList).done((queries) => {
                    // 全局变量赋值
                    [
                        factorInfoAll,
                        stockProductInfoAll,
                        stockManagerInfoAll,
                        bondProductInfoAll,
                        bondManagerInfoAll
                    ] = queries;

                    // 插入因子边栏
                    insertFactorLinks(factorInfoAll);

                    // 股票基金
                    setTimeout(() => {
                        displayStockFundInfo(_.sample(stockProductInfoAll).fundcode)
                    }, 1000);


                    // 股票经理
                    setTimeout(() => {
                        var sampleR = _.sample(stockManagerInfoAll)
                        displayStockManagerInfo('' + sampleR.managerid + ',' + sampleR.groupid)
                    }, 2000);


                    // 债券基金
                    setTimeout(() => {
                        displayBondProductInfo(_.sample(bondProductInfoAll)['fundcode'])
                    }, 3000);


                    // 债券经理
                    setTimeout(() => {
                        displayBondManagerInfo(_.sample(bondManagerInfoAll)['managerid'])
                    }, 4000);


                    setTimeout(() => {
                        onPortSelect()
                    }, 5000);


                })


                // 因子近期表现
                // setTimeout(renderMultiFactorRecent, 10000);
                // 

                // 因子区间表现
                // setTimeout(renderMultiFactorInterval,30000);
                // 


            }
        )


        class TimeLineDataset {
            constructor(title, indicators, limit, timeticks, values, placement, subTitle = '') {
                [this.title, this.indicators, this.limit, this.timeticks, this.values, this.placement, this.subTitle] = [title, indicators, limit, timeticks, values, placement, subTitle]
            }
        }
        // 小函数
        // 保留两位小数
        const f2 = (n) => _.round(n, 2)
            // 保留三位小数
        const f3 = (n) => _.round(n, 3)
            // 保留两位小数，变成百分数
        const fp = (n) => _.truncate((n * 100).toPrecision(5), {
                'length': 5,
                'omission': '%'
            })
            // 转置，transpose
        const transpose = arr => _.zip.apply(_, arr)
            // 计算标准差
        const standardDeviation = (arr, usePopulation = false) => {
            const mean = arr.reduce((acc, val) => acc + val, 0) / arr.length;
            return Math.sqrt(
                arr.reduce((acc, val) => acc.concat((val - mean) ** 2), []).reduce((acc, val) => acc + val, 0) /
                (arr.length - (usePopulation ? 0 : 1))
            );
        };
        // 计算累乘cumprod
        const cumulativeProduct = (arr) => {
            let output = [];
            let x = 1;
            for (i = 0; i < arr.length; i++) {
                x = x * arr[i];
                output.push(x);
            }
            return output
        };
        // 累计最大值
        const cummax = (arr) => {
                var currMax = -Infinity;
                var currMaxArr = [];
                for (const iterator of arr) {
                    currMax = currMax >= iterator ? currMax : iterator
                    currMaxArr.push(currMax)
                }
                return currMaxArr
            }
            // 累计最大回撤
        const maxDrawdown = (arr) => {
                var currMax = -Infinity;
                var drawdowns = [];
                for (const iterator of arr) {
                    currMax = currMax >= iterator ? currMax : iterator
                    drawdowns.push(1 - iterator / currMax)
                }
                return drawdowns
            }
            // 随机字符串，长度7
        const randomString = () => {
                const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                return _.range(7).map(e => _.sample(possible)).join('');
            }
            // 随机字符串组
        const getRandomStringSeries = (length) => {
                return _.range(length).map(e => randomString())
            }
            // 实现cummax, cumsum等函数的前置条件
        Array.prototype.accumulate = function(fn) {
            var r = [this[0]];
            for (var i = 1; i < this.length; i++)
                r.push(fn(r[i - 1], this[i]));
            return r;
        }


        // tab-table的初始化程序
        function initTabTable(tabList, multiID) {

            // 初始化tab的table
            tab_elem = document.querySelector(`#${multiID} nav div`);
            tbl_elem = document.querySelector(`#${multiID} div.tab-content`);
            // 填入虚拟数据
            table_list = tabList.map(element => Object.create({
                header: getRandomStringSeries(6),
                values: _.range(5).map(e => getRandomStringSeries(6)),
                tb_name: element
            }));
            for (const element of table_list) {
                insertTabTable(element, tab_elem, tbl_elem)
            }
        }

        function insertTabTable(tableObj, tab_elem, tbl_elem) {
            // 把table插入tab中
            // tab组
            let tab_id = randomString();
            let tab_instance = $('<a class="nav-item nav-link " data-toggle="tab" role="tab" aria-selected="false"></a>').get(0);
            tab_instance.ariaSelected = true;
            tab_instance.href = '#' + tab_id;
            tab_instance.textContent = tableObj.tb_name;

            //如果是第一个，就要秀出来
            if (tab_elem.children.length == 0) tab_instance.classList.add('active');
            tab_elem.appendChild(tab_instance);

            // 表组
            let tbl_id = randomString();
            let tbl_instance = $('<div class="tab-pane fade" role="tabpanel"><h4><br></h4><small style="color:rgba(96,96,96,.934)">单击列名进行排序，按住Shift点击进行多列排序。</small><div class="table-responsive-lg"></div></div>').get(0);
            tbl_instance.id = tab_id;
            tbl_instance.querySelector('div').id = tbl_id; //表的id，用于插入数据
            tbl_instance.querySelector('h4').innerHTML = '<br>' + tableObj.tb_name; //表的标题

            //如果是第一个，就要秀出来
            if (tbl_elem.children.length == 0) tbl_instance.classList.add('show', 'active');
            tbl_elem.appendChild(tbl_instance);

            //创建表元素，插入容器
            document.getElementById(tbl_id).appendChild(createTable(tableObj));
        }
        // tab-table的sorter
        function makeSortable(selector) {
            $(selector).tablesorter({
                sortMultiSortKey: "shiftKey", // The key used to select more than one column for multi-column sorting.
                sortInitialOrder: "desc", // starting sort direction "asc" or "desc"
            });
        }



        // 插入option的同时，清除之前的数据，同时使得图像resizable
        function insertOption(placement, option) {
            // 如果不clear数据的话，有可能会有重叠，zoom一下能好，但第一眼不美观
            chart = echarts.init($('#' + placement).get(0));
            chart.clear();
            chart.setOption(option);
            // 如果窗口的大小变化了，echart也要跟着变化
            $(window).on("resize", () => {
                echarts.init($('#' + placement).get(0)).resize()
            })
        }


        // 页面跳转控制函数
        function showSubApp(appId) {
            let appIds = ['single_factor_dashboard', 'multi_factor_recent', 'multi_factor_interval', 'fofinfo_stock_product', 'fofinfo_stock_manager', 'fofinfo_bond_product', 'fofinfo_bond_manager', 'fofinfo_portfolio_track'];
            for (let count = 0; count < appIds.length; count++) {
                const idPlacement = appIds[count];
                document.getElementById(idPlacement).hidden = true;
            };
            document.getElementById(appId).hidden = false;
            $(window).trigger('resize');
        }

        function showApp(app_id) {
            // 隐藏登录页面
            // 展示其他页面
            $('[id*="_app"]').hide();

            if (window.isAuthenticated) {
                $('#' + app_id).show();
                $(window).trigger('resize');
            } else {
                $('#auth_app').show();
            }
        }

        const login = () => {
            // 验证用户
            // 修改window全局变量isAuthenticated
            var inputUser = $('#inputEmail').val(),
                inputPassword = md5($('#inputPassword').val());
            window.inputUser = inputUser;
            sqlBindList = [{
                sql: `select * from dfUser where (nickname='${inputUser}' and pwd='${inputPassword}')`,
                bind: 'dfquant'
            }, ]
            postSQLs(sqlBindList).done((queries) => {
                result = queries[0];

                if (result.length) {
                    window.isAuthenticated = true
                    showApp('factorinfo_app');
                    showSubApp("single_factor_dashboard")
                } else {
                    window.isAuthenticated = false
                    showApp('auth_app');
                    alert('密码错误');
                }
            })
        }



        // 侧栏，插入因子名及分类
        const insertFactorLinks = (factorInfoAll) => {
                // 取出因子名极其分类，插入侧栏
                var gnames = [...new Set(factorInfoAll.map(e => e.gname))];
                for (const gname of gnames) {
                    $('#factorCategory').append($(`<li><a href="#collapse${gname}" type="button" data-toggle="collapse"> ${gname}</a></li>`))
                    $('#factorCategory').append($(`<div class="collapse" id="collapse${gname}"></div>`))
                };
                for (const item of factorInfoAll) {
                    if (item['gname'] != item['fname']) {
                        $(`#collapse${item['gname']}`).append(
                            $(`<li class="nav-item"><a class="nav-link" style="color:#D3B454;" href="#" onclick="displaFactorInfo(this.text)">${item['fname']}</a></li>`)
                        )
                    } else {
                        $(`#collapse${item['gname']}`).append(
                            $(`<li class="nav-item"><a class="nav-link" style="color:#D3B454;" href="#" onclick="displaFactorInfo('${item['fname']}')">${item['fname']}大类</a></li>`)
                        )
                    }
                };
                // 把css和类加上，如果放在模板里面看着太繁琐
                $('#factorCategory > li').addClass('nav-item').css('background-color', '#DAA620');
                $('#factorCategory > li > a').addClass('nav-link dropdown-toggle collapsed').css('color', 'white');
                // 展开value类因子列表
                $('#factorCategory > li > a').first().click();
                // 点击value类的第一个因子,一秒后执行
                setTimeout(() => {
                    $('#collapseValue > li:nth-child(1) > a').first().click()
                }, 1000)

            }
            // 单因子dashboard
        const displaFactorInfo = (fname) => {

                var r = factorInfoAll.filter(e => e.fname == fname)[0];
                $("#factorIntro h3").text([fname, r['fdef'], ].join(' '))
                var inputs = $('#fFilter .form-control')
                var fStart = inputs[0].value;
                var fEnd = inputs[1].value;
                var fNeu = inputs[2].value;
                var fUniv = inputs[3].value;

                sqlBindList = [{
                        "sql": `
                       SELECT
                           *
                       FROM
                           ft_monthly_returns
                       WHERE (tradingdate BETWEEN '${fStart}'
                           AND '${fEnd}')
                       and(neutral = ${fNeu})
                       and(universe = '${fUniv}')
                       and(fid = (
                               SELECT
                                   fid FROM factorInfo
                               WHERE
                                   fname = '${fname}'))
                                   ORDER BY tradingdate asc
                                `,
                        'bind': 'ft_update'
                    }, {
                        "sql": `
                       SELECT
                           *
                       FROM
                           ft_daily_returns
                       WHERE (tradingdate BETWEEN '${fStart}'
                           AND '${fEnd}')
                       and(neutral = ${fNeu})
                       and(universe = '${fUniv}')
                       and(fid = (
                               SELECT
                                   fid FROM factorInfo
                               WHERE
                                   fname = '${fname}'))
                                   ORDER BY tradingdate asc`,
                        'bind': 'ft_update'
                    },

                ]
                postSQLs(sqlBindList).done((queries) => {
                    // 月度收益
                    renderFunc = (result) => {
                        // 这个post的数据完全来自于ft_monthly_returns

                        // 更新第一张图
                        var attrs = ['D01', 'D02', 'D03', 'D04', 'D05', 'D06', 'D07', 'D08', 'D09', 'D10']
                        drawBucketRet({
                            placement: 'bucketExRet',
                            x: ['G1', 'G2', 'G3', 'G4', 'G5', 'G6', 'G7', 'G8', 'G9', 'G10'],
                            fname: fname,
                            y: attrs.map(attr => _.round(_.meanBy(result, attr), 3))
                        })

                        // 更新第二张表
                        // ic
                        var ic = f3(_.meanBy(result, 'rankic'));
                        // icir
                        var icir = f3(ic / standardDeviation(result.map(e => e.rankic)) * Math.pow(12, 0.5));
                        // 得到月度ret序列
                        var monRetArr = result.map(e => (e.D10 - e.D01) * r['fcharacter'])
                            // meanmonret
                        var meanMonRet = fp(_.mean(monRetArr));
                        // hitratio
                        var hitRatio = fp(monRetArr.filter(e => e > 0 ? 1 : 0).length / monRetArr.length);
                        // lsir
                        var lsic = _.round(_.mean(monRetArr), 3);
                        var lsir = f3(lsic / standardDeviation(monRetArr) * Math.pow(12, 0.5));

                        createFactorGreek({
                            chart: $("#factorPerfTable").get(0),
                            tableHead: $('#factorPerfTableHead').get(0),
                            x: ['IC', 'IC_IR', 'MeanMonRet', 'HitRatio', 'L-S IR', 'MaxDD'],
                            col: 1,
                            fname: fname,
                            y: [ic, icir, meanMonRet, hitRatio, lsir]
                        })

                        // 更新第三张图
                        drawMonthlyBar({
                            placement: 'monPerf',
                            fname: fname,
                            x: result.map(e => e.tradingdate),
                            y1: monRetArr,
                            y2: result.map(e => e.rankic)
                        });

                    };
                    renderFunc(queries[0]);


                    // 日度收益
                    renderFunc = (result) => {
                        // 这个post的数据完全来自于ft_daily_returns


                        // 更新第一行第二张表的maxdd
                        // maxdd
                        var netV_LS10 = result.map(e => e.netV_LS10);
                        var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                        $('#factorPerfTable > table > tbody > tr:nth-child(6) > td').text(maxDD)

                        // 更新第三行的图
                        var netV_LS10 = result.map(e => e.netV_LS10);
                        netV_LS10 = netV_LS10.map(e => e / netV_LS10[0]);
                        var netV_L10 = result.map(e => e.netV_L10);
                        netV_L10 = netV_L10.map(e => e / netV_L10[0]);
                        var netV_FMP = result.map(e => e.netV_FMP);
                        netV_FMP = netV_FMP.map(e => e / netV_FMP[0]);

                        drawNetDD({
                            placement: "netDD",
                            fname: fname,
                            x: result.map(e => e.tradingdate),
                            y1: netV_LS10,
                            y2: netV_L10,
                            y3: netV_FMP,
                        });

                    }
                    renderFunc2 = (result) => {
                        // 这个post来自于ft_daily_returns

                        var netV_LS10 = result.map(e => e.LS10 + 1).accumulate(function(x, y) {
                            return x * y
                        });
                        var netV_L10 = result.map(e => e.L10 + 1).accumulate(function(x, y) {
                            return x * y
                        });
                        var netV_FMP = result.map(e => e.FMP + 1).accumulate(function(x, y) {
                            return x * y
                        });

                        // 更新第一行第二张表的maxdd
                        var maxDD = fp(_.max(maxDrawdown(netV_LS10)))
                        $('#factorPerfTable > table > tbody > tr:nth-child(6) > td').text(maxDD)

                        // 更新第三行的图
                        drawNetDD({
                            placement: "netDD",
                            fname: fname,
                            x: result.map(e => e.tradingdate),
                            y1: netV_LS10,
                            y2: netV_L10,
                            y3: netV_FMP,
                        });

                    }
                    renderFunc2(queries[1]);
                })


            }
            // 因子近期表现
        const renderMultiFactorRecent = () => {
                var todayFake = '2016-11-01';
                // 取出半年的月度数据，以及半年的日数据
                var fStart = moment().subtract(200, 'days').format('YYYY-MM-DD')
                var fEnd = moment().format('YYYY-MM-DD')
                var fNeu = $('#multi_factor_recent_filter select')[0].value;
                var fUniv = $('#multi_factor_recent_filter select')[1].value;

                // 初始化bootstrap-table
                $('#multi_factor_recent table').attr({
                    "data-height": "400",
                });

                sqlBindList = [{
                    "sql": `
                       SELECT
                           *
                       FROM
                           ft_monthly_returns
                       WHERE (tradingdate BETWEEN '${fStart}'
                           AND '${fEnd}')
                       and(neutral = ${fNeu})
                       and(universe = '${fUniv}')
                       ORDER BY tradingdate asc
                       `,
                    'bind': 'ft_update'
                }, {
                    "sql": `
                       SELECT
                           *
                       FROM
                           ft_daily_returns
                       WHERE (tradingdate BETWEEN '${fStart}'
                           AND '${fEnd}')
                       and(neutral = ${fNeu})
                       and(universe = '${fUniv}')
                       ORDER BY tradingdate asc
                       `,
                    'bind': 'ft_update'
                }];
                postSQLs(sqlBindList).done((queries) => {
                    renderFunc = (result, dailyResult) => {

                        // 大类因子和小因子排到一起
                        var factorInfos = _.sortBy(factorInfoAll, e => e.fgroup)

                        // 一周数据
                        var table_data = [];
                        for (const factorInfo of factorInfos) {
                            // 大类因子的名称有些许不同
                            let fname = factorInfo['fname'] == factorInfo['gname'] ? '<b>' + factorInfo['fname'] + '大类</b>' : factorInfo['fname']
                            fname = [fname, factorInfo['fdef']].join(' ')
                                // 某因子的倒数5个records,只要最后五天
                            const factorRecords = dailyResult.filter(e => e.fid == factorInfo['fid']).slice(-5)
                                // 得到日度度ret序列
                            const retArr = factorRecords.map(e => e.LS10)
                                // 日均收益
                            const avgret = f3(_.mean(retArr));
                            // 胜率
                            const hitRatio = f3(retArr.filter(e => e > 0).length / retArr.length);
                            // lsir
                            const lsic = f3(_.mean(retArr));
                            const lsir = f3(lsic / standardDeviation(retArr) * Math.pow(250, 0.5));
                            // 最大回撤
                            var netV_LS10 = factorRecords.map(e => e.LS10 + 1).accumulate(function(x, y) {
                                return x * y
                            });
                            var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                            // const maxDD = f3(_.minBy(factorRecords, 'maxDD_LS10')['maxDD_LS10']);
                            table_data.push({
                                fname: fname,
                                avgret: avgret,
                                hitratio: hitRatio,
                                lsir: lsir,
                                maxdd: maxDD,
                            })
                        }
                        $('#multi_factor_week_div').html(
                            `
                               <h4 style="color: #DAA620;">最近一周</h4>
                               <table id="multi_factor_week" class="table-striped">
                           <thead>
                               <tr>
                                   <th data-field="fname" data-sortable="true">因子名称</th>
                                   <th data-field="avgic" data-sortable="true">日均IC</th>
                                   <th data-field="icir" data-sortable="true">IC_IR</th>
                                   <th data-field="avgret" data-sortable="true">日均多空收益率</th>
                                   <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                   <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                   <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                               </tr>
                           </thead>
                       </table>
                               `
                        );
                        $('#multi_factor_week').attr({
                            "data-height": "400",
                        });
                        $('#multi_factor_week').bootstrapTable({
                            data: table_data
                        })


                        // 近一个月数据
                        var table_data = [];
                        for (const factorInfo of factorInfos) {
                            // 大类因子的名称有些许不同
                            let fname = factorInfo['fname'] == factorInfo['gname'] ? '<b>' + factorInfo['fname'] + '大类</b>' : factorInfo['fname']
                            fname = [fname, factorInfo['fdef']].join(' ')
                                // 某因子的倒数1个records
                            const factorRecords = result.filter(e => e.fid == factorInfo['fid']).slice(-1)
                                // 月均IC
                            const ic = f3(_.meanBy(factorRecords, 'rankic'));
                            // icir
                            const icir = f3(ic / standardDeviation(factorRecords.map(e => e.rankic)) * Math.pow(12, 0.5));
                            // 得到月度ret序列
                            const retArr = factorRecords.map(e => (e.D10 - e.D01) * factorInfo['fcharacter'])
                                // 日均收益
                            const avgret = f3(_.mean(retArr));
                            // 胜率
                            const hitRatio = f3(retArr.filter(e => e > 0).length / retArr.length);
                            // lsir
                            const lsic = f3(_.mean(retArr));
                            const lsir = f3(lsic / standardDeviation(retArr) * Math.pow(12, 0.5));

                            // 最大回撤
                            const dailyRecords = dailyResult.filter(e => e.fid == factorInfo['fid']).filter(e => e.tradingdate > moment().subtract(30, 'days').format('YYYY-MM-DD'))

                            var netV_LS10 = dailyRecords.map(e => e.LS10 + 1).accumulate(function(x, y) {
                                return x * y
                            });
                            var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                            // const minby = _.minBy(dailyRecords, 'maxDD_LS10')
                            // const maxDD = minby ? f3(minby['maxDD_LS10']) : undefined;

                            table_data.push({
                                avgic: ic,
                                // icir:icir,
                                fname: fname,
                                avgret: avgret,
                                // hitratio: hitRatio,
                                // lsir: lsir,
                                maxdd: maxDD
                            })
                        }

                        $('#multi_factor_month_div').html(
                            `
                               <h4 style="color: #DAA620;">最近一月</h4>
                               <table id="multi_factor_month"class="table-striped">
                                   <thead>
                                       <tr>
                                           <th data-field="fname" data-sortable="true">因子名称</th>
                                           <th data-field="avgic" data-sortable="true">月度IC</th>
                                           <th data-field="icir" data-sortable="true">IC_IR</th>
                                           <th data-field="avgret" data-sortable="true">月度多空收益率</th>
                                           <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                           <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                           <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                       </tr>
                                   </thead>
                               </table>
                               `
                        );
                        $('#multi_factor_month').attr({
                            "data-height": "400",
                        });
                        $('#multi_factor_month').bootstrapTable({
                            data: table_data
                        });

                        // 近三个月数据
                        var table_data = [];
                        for (const factorInfo of factorInfos) {
                            // 大类因子的名称有些许不同
                            let fname = factorInfo['fname'] == factorInfo['gname'] ? '<b>' + factorInfo['fname'] + '大类</b>' : factorInfo['fname']
                            fname = [fname, factorInfo['fdef']].join(' ')
                                // 某因子的倒数3个records
                            const factorRecords = result.filter(e => e.fid == factorInfo['fid']).slice(-3)
                                // 月均IC
                            const ic = f3(_.meanBy(factorRecords, 'rankic'));
                            // icir
                            const icir = f3(ic / standardDeviation(factorRecords.map(e => e.rankic)) * Math.pow(12, 0.5));
                            // 得到月度ret序列
                            const retArr = factorRecords.map(e => (e.D10 - e.D01) * factorInfo['fcharacter'])
                                // 月均收益
                            const avgret = f3(_.mean(retArr));
                            // 胜率
                            const hitRatio = f3(retArr.filter(e => e > 0).length / retArr.length);
                            // lsir
                            const lsic = f3(_.mean(retArr));
                            const lsir = f3(lsic / standardDeviation(retArr) * Math.pow(12, 0.5));
                            // 最大回撤
                            const dailyRecords = dailyResult.filter(e => e.fid == factorInfo['fid']).filter(e => e.tradingdate > moment().subtract(30 * 3, 'days').format('YYYY-MM-DD'))

                            var netV_LS10 = dailyRecords.map(e => e.LS10 + 1).accumulate(function(x, y) {
                                return x * y
                            });
                            var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                            // const minby = _.minBy(dailyRecords, 'maxDD_LS10')
                            // const maxDD = minby ? f3(minby['maxDD_LS10']) : undefined;
                            table_data.push({
                                avgic: ic,
                                icir: icir,
                                fname: fname,
                                avgret: avgret,
                                hitratio: hitRatio,
                                lsir: lsir,
                                maxdd: maxDD
                            })
                        }

                        $('#multi_factor_quarter_div').html(
                            `
                               <h4 style="color: #DAA620;">最近三月</h4>
                               <table id="multi_factor_quarter"class="table-striped">
                                   <thead>
                                       <tr>
                                           <th data-field="fname" data-sortable="true">因子名称</th>
                                           <th data-field="avgic" data-sortable="true">月均IC</th>
                                           <th data-field="icir" data-sortable="true">IC_IR</th>
                                           <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                           <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                           <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                           <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                       </tr>
                                   </thead>
                               </table>
                               `
                        );
                        $('#multi_factor_quarter').attr({
                            "data-height": "400",
                        });
                        $('#multi_factor_quarter').bootstrapTable({
                            data: table_data
                        })

                        // 近六个月数据
                        var table_data = [];
                        for (const factorInfo of factorInfos) {
                            // 大类因子的名称有些许不同
                            let fname = factorInfo['fname'] == factorInfo['gname'] ? '<b>' + factorInfo['fname'] + '大类</b>' : factorInfo['fname']
                            fname = [fname, factorInfo['fdef']].join(' ')
                                // 某因子的倒数6个records
                            const factorRecords = result.filter(e => e.fid == factorInfo['fid']).slice(-6)
                                // 月均IC
                            const ic = f3(_.meanBy(factorRecords, 'rankic'));
                            // icir
                            const icir = f3(ic / standardDeviation(factorRecords.map(e => e.rankic)) * Math.pow(12, 0.5));
                            // 得到月度ret序列
                            const retArr = factorRecords.map(e => (e.D10 - e.D01) * factorInfo['fcharacter'])
                                // 月均收益
                            const avgret = f3(_.mean(retArr));
                            // 胜率
                            const hitRatio = f3(retArr.filter(e => e > 0).length / retArr.length);
                            // lsir
                            const lsic = f3(_.mean(retArr));
                            const lsir = f3(lsic / standardDeviation(retArr) * Math.pow(12, 0.5));
                            // 最大回撤
                            const dailyRecords = dailyResult.filter(e => e.fid == factorInfo['fid']).filter(e => e.tradingdate > moment().subtract(30 * 6, 'days').format('YYYY-MM-DD'))

                            var netV_LS10 = dailyRecords.map(e => e.LS10 + 1).accumulate(function(x, y) {
                                return x * y
                            });
                            var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                            // const minby = _.minBy(dailyRecords, 'maxDD_LS10');
                            // const maxDD = minby ? f3(minby['maxDD_LS10']) : undefined;
                            table_data.push({
                                avgic: ic,
                                icir: icir,
                                fname: fname,
                                avgret: avgret,
                                hitratio: hitRatio,
                                lsir: lsir,
                                maxdd: maxDD
                            })
                        }

                        $('#multi_factor_semi_div').html(
                            `
                               <h4 style="color: #DAA620;">最近六月</h4>
                               <table id="multi_factor_semi"class="table-striped">
                                   <thead>
                                       <tr>
                                           <th data-field="fname" data-sortable="true">因子名称</th>
                                           <th data-field="avgic" data-sortable="true">月均IC</th>
                                           <th data-field="icir" data-sortable="true">IC_IR</th>
                                           <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                           <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                           <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                           <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                       </tr>
                                   </thead>
                               </table>
                               `
                        );
                        $('#multi_factor_semi').attr({
                            "data-height": "400",
                        });
                        $('#multi_factor_semi').bootstrapTable({
                            data: table_data
                        })

                    };
                    renderFunc(queries[0], queries[1])
                })
            }
            // 因子区间表现
        const renderMultiFactorInterval = () => {
            // 取出区间的月度数据，以及区间的日数据
            var fStart = $('#multi_factor_interval_filter input')[0].value;
            var fEnd = $('#multi_factor_interval_filter input')[1].value;
            var fNeu = $('#multi_factor_interval_filter select')[0].value;
            var fUniv = $('#multi_factor_interval_filter select')[1].value;

            sqlBindList = [{
                "sql": `
               SELECT
                   *
               FROM
                   ft_monthly_returns
               WHERE (tradingdate BETWEEN '${fStart}'
                   AND '${fEnd}')
               and(neutral = ${fNeu})
               and(universe = '${fUniv}')
               `,
                'bind': 'ft_update'
            }, {
                "sql": `
               SELECT
                   *
               FROM
                   ft_daily_returns
               WHERE (tradingdate BETWEEN '${fStart}'
                   AND '${fEnd}')
               and(neutral = ${fNeu})
               and(universe = '${fUniv}')
               `,
                'bind': 'ft_update'
            }];
            postSQLs(sqlBindList).done((queries) => {

                renderFunc = (result, dailyResult) => {

                    // 大类因子和小因子排到一起
                    var factorInfos = _.sortBy(factorInfoAll, e => e.fgroup)

                    var table_data = [];
                    for (const factorInfo of factorInfos) {
                        // 大类因子的名称有些许不同
                        let fname = factorInfo['fname'] == factorInfo['gname'] ? '<b>' + factorInfo['fname'] + '大类</b>' : factorInfo['fname']
                        fname = [fname, factorInfo['fdef']].join(' ')
                            // 某因子的倒数6个records
                        const factorRecords = result.filter(e => e.fid == factorInfo['fid'])
                            // 月均IC
                        const ic = f3(_.meanBy(factorRecords, 'rankic'));
                        // icir
                        const icir = f3(ic / standardDeviation(factorRecords.map(e => e.rankic)) * Math.pow(12, 0.5));
                        // 得到日度度ret序列
                        const retArr = factorRecords.map(e => (e.D10 - e.D01) * factorInfo['fcharacter'])
                            // 日均收益
                        const avgret = f3(_.mean(retArr));
                        // 胜率
                        const hitRatio = f3(retArr.filter(e => e > 0).length / retArr.length);
                        // lsir
                        const lsic = f3(_.mean(retArr));
                        const lsir = f3(lsic / standardDeviation(retArr) * Math.pow(12, 0.5));
                        // 最大回撤
                        const dailyRecords = dailyResult.filter(e => e.fid == factorInfo['fid'])

                        var netV_LS10 = dailyRecords.map(e => e.LS10 + 1).accumulate(function(x, y) {
                            return x * y
                        });
                        var maxDD = fp(_.max(maxDrawdown(netV_LS10)))

                        // const maxDD = f3(_.minBy(dailyRecords, 'maxDD_LS10')['maxDD_LS10']);
                        table_data.push({
                            avgic: ic,
                            icir: icir,
                            fname: fname,
                            avgret: avgret,
                            hitratio: hitRatio,
                            lsir: lsir,
                            maxdd: maxDD
                        })
                    }

                    $('#multi_factor_interval_table_div').html(
                        `
                                <h4 style="text-align:center;color: #DAA620;">区间因子表现</h4>
                                <div style="text-align:center;vertical-align:middle">
                                    <small style="color:rgba(96,96,96,.934);">
                                        数据下载时间约15s。
                                    </small>
                                </div>
                                <table id="multi_factor_interval_table" class="table-striped">
                                    <thead>
                                        <tr>
                                            <th data-field="fname" data-sortable="true">因子名称</th>
                                            <th data-field="avgic" data-sortable="true">月均IC</th>
                                            <th data-field="icir" data-sortable="true">IC_IR</th>
                                            <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                            <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                            <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                            <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                        </tr>
                                    </thead>
                                </table>
                               `
                    );
                    $('#multi_factor_interval_table').attr({
                        "data-height": "700",
                    });
                    $('#multi_factor_interval_table').bootstrapTable({
                        data: table_data
                    })

                }
                renderFunc(queries[0], queries[1])
            })
        }






        // 画图画表
        function createTable(dataset) {

            let tbl = document.createElement('table');
            tbl.className = 'table';
            tbl.setAttribute("data-toggle", "table");

            // 插入表头
            let header = tbl.createTHead();
            let row = header.insertRow();
            for (const iterator of dataset['header']) {
                let th = document.createElement('th');
                th.appendChild(document.createTextNode(iterator));
                row.appendChild(th)
            }
            // 插入表身
            let tbody = tbl.createTBody();
            for (const row of dataset['values']) {
                let tr = tbody.insertRow();
                for (var cell of row) {
                    let td = tr.insertCell();
                    if (_.isNumber(cell)) {
                        cell = _.round(cell, 3)
                    };
                    td.appendChild(document.createTextNode(cell));
                }
            }
            return tbl
        }
        // 分组超额收益
        function drawBucketRet(dataset) {
            option = {
                grid: {
                    left: '10%',
                    right: '2%'
                },
                title: {
                    text: dataset.fname + " 月度分组超额收益",
                    left: 'center',
                    textStyle: {
                        fontSize: 20
                    }
                },
                tooltip: {
                    trigger: 'axis'
                },
                xAxis: {
                    data: dataset.x
                },
                yAxis: {
                    max: 0.01,
                    min: -0.01,
                    splitLine: {
                        show: false
                    }
                },
                series: [{
                    type: "bar",
                    data: dataset.y,
                    label: {
                        show: true
                    },
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ?
                                new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: '#fcbdc5'
                                }, {
                                    offset: 1,
                                    color: '#c23531'
                                }]) :
                                new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: 'green'
                                }, {
                                    offset: 1,
                                    color: '#91e6a7'
                                }])
                        }
                    }
                }, ]
            };
            insertOption(dataset.placement, option);
        }
        // 因子的评价指标
        function createFactorGreek(dataset) {
            let tbl = document.createElement('table');
            tbl.className = 'table';
            // 插入表身
            let tbody = tbl.createTBody();
            var tr;
            for (let i = 0; i < dataset.x.length; i++) {
                if (i % dataset.col == 0) {
                    tr = tbody.insertRow();
                }
                let th = document.createElement('th');
                $(th).css({
                    'width': '50%'
                });
                th.appendChild(document.createTextNode(dataset.x[i]));
                tr.appendChild(th)
                let td = tr.insertCell();
                $(td).css({
                    'width': '50%'
                });
                td.appendChild(document.createTextNode(dataset.y[i]));

            }
            // 插入容器
            $(dataset.chart).empty();
            dataset.chart.appendChild(tbl);
            dataset.tableHead.innerText = dataset.fname + ' 绩效指标';
        }
        // 月度盈亏
        function drawMonthlyBar(dataset) {
            option = {
                title: {
                    left: 'center',
                    text: dataset.fname + ' 月度盈亏',
                },
                tooltip: {
                    trigger: 'axis',
                },
                toolbox: {
                    feature: {
                        mark: {},
                        dataView: {},
                        magicType: {
                            show: true,
                            type: ['line', 'bar']
                        },
                        restore: {},
                        saveAsImage: {}
                    },
                    right: '10%'
                },
                dataZoom: [{
                    start: 0,
                    end: 100
                }],
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dataset.x,
                    axisTick: {
                        inside: true
                    },
                    axisLine: {
                        onZero: false
                    },
                },
                yAxis: {
                    min: -0.2,
                    max: 0.2,
                    splitLine: {
                        show: true,
                        lineStyle: {
                            opacity: 0.2,
                        },
                    },
                },
                grid: {
                    show: true,
                    top: '10%',
                    containLabel: true,
                    left: '2%',
                    right: '10%'
                },
                legend: {
                    icon: 'none',
                    selectedMode: 'single',
                    top: 0,
                    left: '2%',
                    textStyle: {
                        fontSize: 18
                    },
                    tooltip: {
                        formatter: '点击可选',
                        show: true
                    },
                },
                series: [{
                    name: 'L-S Return',
                    data: dataset.y1,
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ?
                                new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: '#fcbdc5'
                                }, {
                                    offset: 1,
                                    color: '#c23531'
                                }]) :
                                new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: 'green'
                                }, {
                                    offset: 1,
                                    color: '#91e6a7'
                                }])
                        }
                    },
                    type: 'bar',
                }, {
                    name: 'RankIC',
                    data: dataset.y2,
                    itemStyle: {
                        color: (params) => params.value > 0 ? '#c23531' : 'green'
                    },
                    type: 'bar',
                }]
            };
            insertOption(dataset.placement, option);
        }
        // 净值曲线与回撤
        function drawNetDD(dataset) {
            option = {
                title: {
                    text: dataset.fname + ' 净值及回撤',
                    left: 'center',
                    align: 'right'
                },
                grid: {
                    left: '5%',
                    top: '10%',
                    bottom: 80
                },
                toolbox: {
                    left: '82%',
                    feature: {
                        dataView: {},
                        dataZoom: {
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        animation: false,
                        label: {
                            backgroundColor: '#505765'
                        }
                    },
                    formatter: function(params) {
                        return '<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#c23531;"></span>' +
                            'NetValue: ' + params[0].data +
                            '<br><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:#808080;"></span>' +
                            'Drawdown: ' + params[1].data.toFixed(2)
                    },
                },
                legend: {
                    selectedMode: 'single',
                    left: '3%',
                    icon: 'none',
                    textStyle: {
                        fontSize: 18
                    },
                    tooltip: {
                        formatter: '点击可选',
                        show: true
                    }

                },
                dataZoom: [{
                    show: true,
                    realtime: true,
                    start: 0,
                    end: 100
                }, {
                    type: 'inside',
                    realtime: true,
                    start: 0,
                    end: 100
                }],
                xAxis: [{
                    type: 'category',
                    boundaryGap: false,
                    axisLine: {
                        onZero: false
                    },
                    data: dataset.x
                }],
                yAxis: [{
                    name: 'Daily NAV',
                    nameLocation: 'middle',
                    nameRotate: 90,
                    nameGap: 30,
                    type: 'value',
                    min: function(value) {
                        return _.round(value.min - 0.1, 2);
                    },
                    max: function(value) {
                        return _.round(value.max + 0.1, 2);
                    },
                    boundaryGap: [0, '100%'],
                    splitLine: {
                        show: true,
                        lineStyle: {
                            opacity: 0.2,
                        },
                    },

                }, {
                    name: 'Drawdown',
                    nameLocation: 'middle',
                    nameRotate: -90,
                    nameGap: 30,
                    type: 'value',
                    inverse: true,
                    splitLine: {
                        show: false,
                    }
                }],
                series: [{
                    name: 'L-S',
                    type: 'line',
                    lineStyle: {
                        width: 3,
                        color: '#c23531'
                    },

                    data: dataset.y1
                }, {
                    name: 'L-S',
                    type: 'line',
                    yAxisIndex: 1,
                    areaStyle: {
                        color: 'grey'
                    },
                    lineStyle: {
                        width: 1,
                        color: 'grey'
                    },
                    data: maxDrawdown(dataset.y1)
                }, {
                    name: 'Long',
                    type: 'line',
                    lineStyle: {
                        width: 3,
                        color: '#c23531'
                    },

                    data: dataset.y2
                }, {
                    name: 'Long',
                    type: 'line',
                    yAxisIndex: 1,
                    areaStyle: {
                        color: 'grey'
                    },
                    lineStyle: {
                        width: 1,
                        color: 'grey'
                    },
                    data: maxDrawdown(dataset.y2)
                }, {
                    name: 'FP',
                    type: 'line',
                    lineStyle: {
                        width: 3,
                        color: '#c23531'
                    },

                    data: dataset.y3
                }, {
                    name: 'FP',
                    type: 'line',
                    yAxisIndex: 1,
                    areaStyle: {
                        color: 'grey'
                    },
                    lineStyle: {
                        width: 1,
                        color: 'grey'
                    },
                    data: maxDrawdown(dataset.y3)
                }]
            };
            insertOption(dataset.placement, option);
        }
        // 基金信息
        function createFundInfo(dataset) {
            let zipArr = dataset.x.map(function(e, i) {
                return [e, dataset.y[i]];
            });
            let tbl = document.createElement('table');
            tbl.className = 'table';
            // 插入表身
            let tbody = tbl.createTBody();
            for (let i = 0; i < zipArr.length / 2; i++) {
                let tr = tbody.insertRow();
                let row = zipArr[2 * i];
                let row2 = zipArr[2 * i + 1];
                // 搞成两列
                let th = document.createElement('th');
                $(th).css({
                    'width': '25%'
                });
                th.appendChild(document.createTextNode(row[0]));
                tr.appendChild(th)

                let td = tr.insertCell();
                $(td).css({
                    'width': '25%'
                });
                td.appendChild(document.createTextNode(row[1]));

                let th2 = document.createElement('th');
                $(th2).css({
                    'width': '25%'
                });
                th2.appendChild(document.createTextNode(row2[0]));
                tr.appendChild(th2)

                let td2 = tr.insertCell();
                $(td2).css({
                    'width': '25%'
                });
                td2.appendChild(document.createTextNode(row2[1]));

            }
            // 插入容器
            $(dataset.chart).empty();
            dataset.chart.appendChild(tbl);
            dataset.chart.getElementsByTagName('table')[0].setAttribute('class', "table table-striped table-sm")
        }
        // 风格箱
        function drawStyleBox(dataset) {

            let ord_options = dataset.ords.map((ord) => {
                return {
                    series: [{
                        data: [ord],
                        symbolSize: 80,
                        symbol: 'roundRect',
                        label: {
                            normal: {
                                show: true,
                                position: 'inside',
                                formatter: '{c}',
                                fontWeight: 'bolder',
                                fontSize: 16
                            }
                        },
                    }]
                }
            });
            let option = {
                baseOption: {
                    title: {
                        text: '风格箱',
                        textStyle: {
                            fontSize: 24
                        },
                        left: '8%'
                    },
                    timeline: {
                        axisType: 'category',
                        orient: 'vertical',
                        autoPlay: true,
                        inverse: true,
                        playInterval: 1000,
                        right: '10%',
                        top: '15%',
                        width: '18%',
                        height: '80%',
                        label: {
                            position: 'right',
                            verticalAlign: 'middle',
                        },
                        checkpointStyle: {
                            color: '#bbb',
                            borderColor: '#777',
                            borderWidth: 2,
                        },
                        data: dataset.timeline,

                    },
                    grid: {
                        height: '60%',
                        width: '60%',
                        top: '20%'

                    },
                    xAxis: {
                        'type': 'category',
                        'data': dataset.xaxis,
                        axisLabel: {
                            fontSize: 14
                        },
                        splitLine: {
                            show: true
                        }
                    },
                    yAxis: {
                        'type': 'category',
                        'data': dataset.yaxis,
                        axisLabel: {
                            fontSize: 13
                        },
                        splitLine: {
                            show: true
                        }
                    },
                    series: [{
                        type: 'scatter'
                    }]
                },
                options: ord_options,
            };
            insertOption(dataset.placement, option);
        };
        // 静态雷达图
        function drawStaticRadar(dataset) {
            option = {
                title: {
                    text: '最新基金筛选打分',
                    // text: '最新基金筛选打分 综合排名:\n ' + dataset.rank,
                    textStyle: {
                        fontSize: 24
                    },
                    subtext: dataset.subTitle || ''
                },
                tooltip: {
                    formatter: function(params, ticket, callback) {
                        var labels = dataset.indicators,
                            values = params.value;
                        // 按照暴露值来排序
                        var sorted = _.zip(labels, values).sort((a, b) => b[1] - a[1])
                        var f = params.seriesName;
                        for (let i = 0; i < labels.length; i++) {
                            const label = sorted[i][0];
                            const value = sorted[i][1];
                            f += '<br>' + label + ': ' + value
                        }
                        return f
                    }
                },
                radar: {
                    radius: '70%',
                    shape: 'circle',
                    name: {
                        textStyle: {
                            fontSize: 14,
                            color: '#444'
                        },
                    },
                    nameGap: 2,
                    indicator: dataset.indicators.map((idc) => {
                        return {
                            name: idc,
                            max: 100
                        }
                    })
                },
                series: [{
                    name: '基金筛选打分',
                    type: 'radar',
                    areaStyle: {
                        normal: {}
                    },
                    data: [{
                        value: dataset.value,
                        name: '打分'
                    }]
                }]
            };
            insertOption(dataset.placement, option);
        }
        // 时间线雷达图
        function drawTimelineRadar(dataset) {
            let idct = dataset.indicators.map(w => {
                return {
                    name: w,
                    min: dataset.limit[0],
                    max: dataset.limit[1]
                }
            });
            let opts = dataset.values.map(datarow => {
                return {
                    series: [{
                        name: dataset.title,
                        data: [{
                            value: datarow,
                            label: {
                                show: idct.length > 14 ? false : true,
                                distance: 10,

                            }
                        }],
                        areaStyle: {},
                        clip: true

                    }]
                }
            })

            option = {

                baseOption: {
                    toolbox: {
                        show: true,
                        feature: {
                            dataView: {
                                show: true,
                                readOnly: false
                            },
                            saveAsImage: {
                                show: true
                            }
                        }
                    },
                    timeline: {
                        axisType: 'category',
                        // autoPlay: true,
                        // loop: false,
                        currentIndex: dataset.timeticks.length - 1,
                        data: dataset.timeticks,
                        label: {
                            interval: 0,
                            position: 'top',
                            rotate: dataset.timeticks.length > 8 ? 30 : 10,
                            fontSize: dataset.timeticks.length > 8 ? 8 : 12,
                        },
                        // axisType: 'time',
                        left: 0,
                        right: 0,
                        bottom: 20,
                        width: '90%',
                        height: 1,
                    },
                    title: {
                        text: dataset.title,
                        textStyle: {
                            fontSize: 24
                        },
                        subtext: dataset.subTitle || '',
                        top: 0
                    },
                    tooltip: {
                        formatter: function(params, ticket, callback) {
                            var labels = dataset.indicators,
                                values = params.value;
                            // 按照暴露值来排序
                            var sorted = _.zip(labels, values).sort((a, b) => b[1] - a[1])
                            var f = params.seriesName;
                            for (let i = 0; i < labels.length; i++) {
                                const label = sorted[i][0];
                                const value = sorted[i][1];
                                f += '<br>' + label + ': ' + value
                            }
                            return f
                        }
                    },
                    series: [{
                        type: 'radar'
                    }, ],
                    radar: {
                        indicator: idct,
                        radius: '70%',
                        shape: 'circle',
                        lineStyle: {
                            width: 3,
                            shadowColor: '#c23531',
                            shadowBlur: 50
                        },
                        nameGap: 10,
                        name: {
                            textStyle: {
                                color: '#444'
                            }
                        },
                    },

                },
                options: opts
            };

            insertOption(dataset.placement, option);
        }
        // 基金一览 --> 基金产品分析 --> 产品基本信息
        function createBondFundInfo(dataset) {

            let column_num = 4;
            let tbl = document.createElement('table');
            tbl.className = 'table';
            // 插入表身
            let tbody = tbl.createTBody();
            var tr;
            for (let i = 0; i < dataset.names.length; i++) {
                if (i % column_num == 0) {
                    tr = tbody.insertRow();
                }
                let th = document.createElement('th');
                $(th).css({
                    'width': '12%'
                });
                th.appendChild(document.createTextNode(dataset.names[i]));
                tr.appendChild(th)
                $(th).css({
                    'width': '12%'
                });
                let td = tr.insertCell();
                td.appendChild(document.createTextNode(dataset.values[i]));

            }
            tbl.classList.add('table', 'table-striped', 'table-sm');
            // 插入容器
            $('#' + dataset.placement).empty();
            document.getElementById(dataset.placement).appendChild(tbl);

        }
        // 基金一览 --> 基金组合跟踪 --> 组合绩效指标
        function insertGreekTable(dataset) {

            // 
            let zipArr = dataset.names.map(function(e, i) {
                return [e, dataset.values[i]];
            });
            let tbl = document.createElement('table');
            tbl.className = 'table';
            // 插入表身
            let tbody = tbl.createTBody();
            for (let i = 0; i < zipArr.length; i++) {
                let tr = tbody.insertRow();
                let row = zipArr[i];
                // 搞成两列
                let th = document.createElement('th');
                $(th).css({
                    'width': '50%'
                });
                th.appendChild(document.createTextNode(row[0]));
                tr.appendChild(th)
                let td = tr.insertCell();
                $(th).css({
                    'width': '50%'
                });
                td.appendChild(document.createTextNode(row[1]));
            }
            tbl.classList.add('table', 'table-striped');
            // 插入容器
            $('#' + dataset.placement).empty();
            document.getElementById(dataset.placement).appendChild(tbl);
        }
        // 基金一览 --> 基金组合跟踪 --> 净值曲线 
        function drawLineVsBench(dataset) {

            option = {

                tooltip: {
                    trigger: 'axis',
                    position: function(pt) {
                        return [pt[0], '10%'];
                    },
                    formatter: function(params, ticket, callback) {

                        let f = params[0].name + '<br>';
                        f += params[0].seriesName + ': ' + Math.round(params[0].value * 100) / 100 + '<br>';
                        f += params[1].seriesName + ': ' + Math.round(params[1].value * 100) / 100
                        return f
                    }
                },
                title: {
                    left: '9%',
                    text: '基金净值曲线',
                    textStyle: {
                        fontSize: 24
                    },
                },
                toolbox: {
                    feature: {
                        dataView: {},
                        magicType: {
                            type: ['line', 'bar']
                        },
                        dataZoom: {
                            // 指定哪些 yAxis 被控制。如果缺省则控制所有的y轴。如果设置为 false 则不控制任何y轴。如果设置成 3 则控制 axisIndex 为 3 的y轴。如果设置为 [0, 3] 则控制 axisIndex 为 0 和 3 的y轴。
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: false,
                    data: dataset.x
                },
                yAxis: {
                    type: 'value',
                    boundaryGap: [0, 0],
                    splitLine: {
                        show: true,
                        interval: 3,
                        lineStyle: {
                            opacity: 0.2,
                        },
                    }
                },
                dataZoom: {},
                legend: {
                    top: '5%',
                    tooltip: {
                        formatter: '点击可选',
                        show: true
                    }
                },
                series: [{
                    name: '基金净值',
                    type: 'line',
                    symbol: 'none',
                    sampling: 'average', //折线图在数据量远大于像素点时候的降采样策略，开启后可以有效的优化图表的绘制效率，默认关闭，也就是全部绘制不过滤数据点。
                    areaStyle: {},
                    data: dataset.y1,

                }, {
                    name: '基准净值',
                    type: 'line',
                    symbol: 'none',
                    sampling: 'average', //折线图在数据量远大于像素点时候的降采样策略，开启后可以有效的优化图表的绘制效率，默认关闭，也就是全部绘制不过滤数据点。
                    areaStyle: {},
                    data: dataset.y2
                }]
            };
            insertOption(dataset.placement, option);
        }
        // 基金一览 --> 基金组合跟踪 --> 分年收益柱状图
        function drawBarVsBench(dataset) {


            // 用于series label 的formatter
            let pctFormat = function(d) {
                return (d.data * 100).toFixed(1) + '%'
            }
            option = {
                title: {
                    left: '9%',
                    text: '基金分年收益',
                    textStyle: {
                        fontSize: 24
                    },
                },
                toolbox: {
                    feature: {
                        dataView: {},
                        magicType: {
                            type: ['line', 'bar']
                        },
                        dataZoom: {
                            // 指定哪些 yAxis 被控制。如果缺省则控制所有的y轴。如果设置为 false 则不控制任何y轴。如果设置成 3 则控制 axisIndex 为 3 的y轴。如果设置为 [0, 3] 则控制 axisIndex 为 0 和 3 的y轴。
                            yAxisIndex: 'none'
                        },
                        restore: {},
                        saveAsImage: {}
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    position: function(pt) {
                        return [pt[0], '10%'];
                    },
                    formatter: function(params, ticket, callback) {
                        let f = params[0].name + '<br>';
                        f += params[0].seriesName + ': ' + (params[0].value * 100).toFixed(1) + '%' + '<br>';
                        f += params[1].seriesName + ': ' + (params[1].value * 100).toFixed(1) + '%'
                        return f
                    }
                },
                dataZoom: {},
                legend: {
                    top: '5%',
                    tooltip: {
                        formatter: '点击可选',
                        show: true
                    }
                },
                yAxis: {
                    type: 'value',
                    boundaryGap: ['10%', '30%'], //这个表示min max距离图边界的距离
                    splitLine: {
                        lineStyle: {
                            opacity: 0.2,
                        },
                    }
                },
                xAxis: {
                    type: 'category',
                    data: dataset.x,
                    boundaryGap: true,

                    splitLine: {
                        lineStyle: {
                            color: 'blue'
                        }
                    }
                },
                series: [{
                    name: '净值回报',
                    type: 'bar',
                    data: dataset.y1,
                    label: {
                        show: true,
                        formatter: pctFormat
                    }
                }, {
                    name: '基准回报',
                    type: 'bar',
                    data: dataset.y2,
                    label: {
                        show: true,
                        formatter: pctFormat
                    },
                }]
            };

            insertOption(dataset.placement, option);

        }




        // 股票基金 筛选
        function filterStockFund(searchInput) {
            validResult = stockProductInfoAll.filter(e => (e.fundcode + e.fundname + e.lastmanager).includes(searchInput));
            $('#stockProductSelect').empty().append((validResult.map(e => `<option value="${e.fundcode}" >${e.fundcode}-${e.fundname}-${e.lastmanager}</option>`).join('')));
            if (validResult.length > 1) {
                $('#stockProductSelectAddon').text(validResult.length + '个结果，下拉选择')
            } else if (validResult.length == 1) {
                $('#stockProductSelectAddon').text('1个结果，已显示');
                displayStockFundInfo(validResult[0].fundcode)
            } else {
                $('#stockProductSelectAddon').text('无结果')
            }

        }
        // 股票基金 画图画表
        function displayStockFundInfo(fundcode) {

            // 1-1 基本信息
            var r = stockProductInfoAll.filter(e => e.fundcode == fundcode)[0];
            createFundInfo({
                    x: ['基金名称', '基金公司', 'Wind基金类型', '成立时间', '现任基金经理', '现任基金经理平均从业年限', '基金经理更换次数',
                        '基金经理获金牛奖次数', '最新规模（合计）', '所在公司主动管理规模', '所在公司规模（剔除货币型基金）', 'Wind基准', '管理费率(%)', '数据截止时间'
                    ],
                    y: [r.fundname, r.compname, r.lastsector, r.setupdate, r.lastmanager, _.round(r.avgworklen, 1) + '年', r.changefreq,
                        r.awardnum, _.round(r.totasset / 1e8, 2) + '亿', _.round(r.active / 1e8, 2) + '亿', _.round(r.total_excmoney / 1e8, 2) + '亿', r.benchmark, r.managefee, r.lastdt
                    ],
                    chart: $('#stockProductInfoPlacement').get(0)
                })
                // 替换掉nan值
            $('#stockProductInfoPlacement td').each((index, element) => {
                if (element.innerText.includes('NaN')) {
                    element.innerText = ''
                }
            })



            sqlBindList = [{
                "sql": `select * from fundstylebox where fundcode = '${fundcode}' ORDER BY reportdt`,
                'bind': 'fund'
            }, {
                "sql": `select * from factorrank where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from fundregress where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from fundexp where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from fundperformance where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from fundholdings where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from zscorerank where fundcode = '${fundcode}'`,
                'bind': 'fund'
            }, ]
            postSQLs(sqlBindList).done((queries) => {

                // 1-2 风格箱
                renderFunc = (result) => {
                    drawStyleBox({
                        placement: 'stockProductSBoxPlacement',
                        timeline: result.map(e => e.reportdt),
                        xaxis: ['价值', '平衡', '成长'],
                        yaxis: ['小盘', '中盘', '大盘'],
                        ords: result.map(e => [e.growth_value, e.size])
                    })
                };
                renderFunc(queries[0])

                // 1-3 最新一期基金筛选打分
                var zscorerank = queries[6][0] ? queries[6][0]['zscorerank'] : 'No Data';
                var fchart13 = (result) => {
                        drawStaticRadar({
                            subTitle: '坐标上下限为 [0,100]',
                            placement: 'stockProductRatingRadarPlacement',
                            rank: zscorerank,
                            indicators: ['选股能力', '夏普比率', '最大回撤', '逆境收益率', '基金规模', '基金经理变更次数', '管理人份额持有'],
                            value: result.map(e => _.round(e.factorrank))
                        })
                    }
                    // 3-3 选基因子打分 表
                var ftable33 = (result) => {
                    var xlabels = ['选股能力', '夏普比率', '最大回撤', '逆境收益率', '基金规模', '基金经理变更次数', '管理人份额持有占比']
                    var xindex = ['111', '204', '304', '410', '501', '601', '703']
                    var ylabels = ['因子原始值', '因子标准化ZSCORE', '因子得分']
                    var yindex = ['rawfactorvalue', 'stdfactorvalue', 'factorrank']
                    var dataframe = [],
                        tableIndex = 2;

                    // 填入数据
                    for (const r of result.sort(r => r.factorid)) {
                        dataframe.push([r['rawfactorvalue'], r['stdfactorvalue'], r['factorrank']])
                    }
                    // 转置
                    dataframe = transpose(dataframe);
                    // 插入label
                    for (let yi = 0; yi < ylabels.length; yi++) {
                        const label = ylabels[yi];
                        // !!!!!
                        dataframe[yi].unshift(label)
                    }

                    $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabels],
                        values: dataframe
                    }))
                }
                renderFunc = (result) => {
                    fchart13(result);
                    if (result.length) {

                        ftable33(result)
                    }
                }
                renderFunc(queries[1]);



                // 2-1 基金评价 图
                var fchart21 = (result) => {

                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金评价",
                            indicators = ['择时能力', '选股能力', '行业配置能力'],
                            limit = [0, 100],
                            timeticks = _.reverse(result.map(r => r.interval)),
                            values = _.reverse(result.map(r => [_.round(r.timing_rank), _.round(r.alpha_rank), _.round(r.indus_rank)])),
                            placement = "stock_product_radar1",
                            subTitle = '坐标上下限为 [0,100]',
                        ));
                    }
                    // 3-4 基金评价 表
                var ftable34 = (result) => {

                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = ['timing_rank', 'indus_rank', 'alpha_rank', 'timing_coef', 'indus_coef', 'alpha_coef'];
                    const xlabel = ['择时能力得分', '行业配置能力得分', '选股能力得分', '择时项系数', '行业配置收益(年化)', '选股收益(年化)'];
                    var dataframe = [],
                        tableIndex = 3;

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = result.filter(r => r['interval'] == yindex[i])
                        if (fil.length) {
                            r = fil[0];
                            dataframe.push([ylabel[i]]);
                            for (var j = 0; j < xindex.length; j++) {
                                dataframe[dataframe.length - 1].push(r[xindex[j]]);
                            }
                        }
                    };
                    $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }))
                }
                renderFunc = (result) => {
                    if (result.length) {
                        fchart21(result);
                        ftable34(result)
                    }
                }
                renderFunc(queries[2]);

                // 2-2 风险暴露 图
                var fchart22 = (result) => {

                        var radarx = ['Size', 'Beta', 'Volatility', 'Liquidity', 'Value',
                                'Certainty', 'Cubic size', 'Trend', 'Growth', 'SOE'
                            ],
                            timeticks = [],
                            dataframe = [];

                        _.forIn(_.groupBy(result, 'reportdt'), function(records, dt) {
                            timeticks.push(dt);
                            var entry = _.fromPairs(records.map(r => [r.factorname, f2(r.port)]));
                            dataframe.push(radarx.map(e => entry[e]));
                        });


                        drawTimelineRadar(new TimeLineDataset(
                            title = "因子风格暴露",
                            indicators = radarx,
                            limit = [-1.7286, 1.6649],
                            timeticks = timeticks,
                            values = dataframe,
                            placement = "stock_product_radar2",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));

                    }
                    // 2-3 行业暴露 图
                var fchart23 = (result) => {


                        var radarx = industries,
                            timeticks = [],
                            dataframe = [];

                        _.forIn(_.groupBy(result, 'reportdt'), function(records, dt) {
                            timeticks.push(dt);
                            var entry = _.fromPairs(records.map(r => [r.factorname, f2(r.port)]));
                            dataframe.push(radarx.map(e => entry[e]));
                        })


                        drawTimelineRadar(new TimeLineDataset(
                            title = "行业风格暴露",
                            indicators = industry_labels,
                            limit = [0, 0.3235],
                            timeticks = timeticks,
                            values = dataframe,
                            placement = "stock_product_radar3",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));

                    }
                    // 3-5 风险暴露 表
                var ftable35 = (result) => {
                        var tableIndex = 4,
                            dataframe = [];
                        const xlabel = ["Size", "Beta", "Volatility", "Liquidity", "Value", "Certainty", "Cubic size", "Trend", "Growth", "SOE"];

                        // 以时间进行group，value为label对应的数据
                        _.forOwn(_.groupBy(result, 'reportdt'), (records, dt) => {
                            const factorKV = _.fromPairs(records.map(r => [r.factorname, r.port]))
                            dataframe.push([dt, ...xlabel.map(x => factorKV[x])])
                        });
                        $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                            header: [' ', ...xlabel],
                            values: dataframe
                        }))

                    }
                    // 3-6 行业暴露 表
                var ftable36 = (result) => {
                    var tableIndex = 5,
                        dataframe = [];
                    const xlabel = industries;

                    // 以时间进行group，value为label对应的数据
                    _.forOwn(_.groupBy(result, 'reportdt'), (records, dt) => {
                        const factorKV = _.fromPairs(records.map(r => [r.factorname, r.port]))
                        dataframe.push([dt, ...xlabel.map(x => factorKV[x])])
                    });
                    $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...industry_labels],
                        values: dataframe
                    }))



                }
                renderFunc = (result) => {
                    if (result.length) {
                        fchart22(result);
                        fchart23(result);
                        ftable35(result);
                        ftable36(result);
                    }
                }
                renderFunc(queries[3]);


                // 3-1 基金业绩 表
                renderFunc = (result) => {
                    var y = moment().year();
                    const yindex = ['lastdt', '5dt', '1m', '3m', '6m', '12m', '36m', '60m', 'ytd', 'setupdt', 'y-1', 'y-2', 'y-3', 'y-4', 'y-5'];
                    const ylabel = ['最新交易日', '最近5个交易日', '最近1个月', '最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '年初至今', '成立以来', y - 1 + '', y - 2 + '', y - 3 + '', y - 4 + '', y - 5 + ''];
                    const xindex = ['rank', 'cumret', 'annret', 'annvol', 'annsharpe', 'maxdd'];
                    const xlabel = ['累计收益同类排名', '累计收益', '年化收益', '年化波动率', '年化夏普比率', '最大回撤'];
                    var dataframe = [],
                        tableIndex = 0;

                    for (var i = 0; i < yindex.length; i++) {
                        const r = _.find(result, r => r['section'] == yindex[i])
                        if (r) {
                            dataframe.push([ylabel[i]]);
                            for (const xattr of xindex) {
                                var element = r[xattr];
                                if (['cumret', 'annret', 'annvol', 'maxdd'].includes(xattr)) {
                                    element = fp(element)
                                }; //百分比形式
                                if (['annsharpe'].includes(xattr)) {
                                    element = f2(element)
                                } //两位小数
                                _.nth(dataframe, -1).push(element);
                            }
                        }
                    };

                    $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }))
                }
                renderFunc(queries[4]);

                // 3-2 基金重仓股分析 表
                renderFunc = (result) => {

                    var header = ['股票代码', '股票名称', '重仓次数', '平均持有比例(%)', '累计收益', '最后持有报告期']
                    var xattrs = ['stockcode', 'stockname', 'num', 'avgratio', 'prodret', 'lastpos']
                    var dataframe = [],
                        tableIndex = 1,
                        i = 0;

                    for (const r of result.sort(e => -e.avgratio)) {
                        dataframe.push(
                            [i++, r['stockcode'], r['stockname'], _.round(r['num']), f2(r['avgratio']), fp(r['prodret']), r['lastpos']]
                        )
                    }

                    $(`#stockProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...header],
                        values: dataframe
                    }))
                }
                renderFunc(queries[5]);

                // 使得table可以排序
                makeSortable("#stockProductMulti table")

                // 行业的header设置得宽一点
                $(`#stockProductMulti .table-responsive-lg:nth(5) .tablesorter-header-inner`).css({
                    'width': '4em'
                })
            })



        }

        // 股票经理 筛选
        function filterStockFundManager(searchInput) {
            validResult = stockManagerInfoAll.filter(e => ('' + e.name + e.gender + e.edu + e.compname + e.maxasset).includes(searchInput));
            $('#stockManagerSelect').empty().append((validResult.map(e => `<option value="${e.managerid},${e.groupid}">${e.name}-\
               ${e.gender}-${e.edu}-${e.compname}-${e.maxasset}-${groupidMap[e.groupid]}</option>`).join('')));
            if (validResult.length > 2) {
                $('#stockManagerSelectAddon').text(validResult.length + '个结果，下拉选择')
            } else if (validResult.length == 2) {
                $('#stockProductSelectAddon').text('2个结果，已显示其一');
                displayStockManagerInfo(`${validResult[0].managerid},${validResult[0].groupid}`)
            } else {
                $('#stockManagerSelectAddon').text('无结果')
            }
        }
        // 股票经理 画图画表
        function displayStockManagerInfo(selectedValue) {
            var [managerid, groupid] = selectedValue.split(',');
            var sqlStatement, bindDB = 'fund',
                renderFunc;

            // 第一行第一张表
            var r = _.find(stockManagerInfoAll, e => e.managerid == managerid && e.groupid == groupid);
            createFundInfo({
                x: ["姓名", "性别", "学历", "公募从业年限", "公募历任公司数", "当前管理的同类产品个数", "历史管理的同类产品个数",
                    "当前管理的同类产品中规模最大的基金", "当前管理的同类产品规模", "当前管理的所有产品规模",
                    "所在公司主动管理规模", "所在公司规模（剔除货币型基金）", "获金牛奖次数", "数据截止时间"
                ],
                y: [r.name, r.gender, r.edu, _.round(r.worklen, 1) + '年', _.round(r.jobfreq), r.lastfundnum, r.hisfundnum,
                    r.maxasset, _.round(r.totalasset1 / 1e8, 2) + '亿', _.round(r.totalasset2 / 1e8, 2) + '亿',
                    _.round(r.active / 1e8, 2) + '亿', _.round(r.total_excmoney / 1e8, 2) + '亿', r.awardnum, r.lastdt
                ],
                chart: $('#stock_manager_profile').get(0),
            })
            $('#stock_manager_profile td').each((index, element) => {
                if (element.innerText.includes('NaN')) {
                    element.innerText = ''
                }
            })

            sqlBindList = [{
                "sql": `select * from managerstylebox where managerid = '${managerid}' and groupid = '${groupid}'ORDER BY reportdt`,
                'bind': 'fund'
            }, {
                "sql": `select * from managerregress where managerid = '${managerid}' and groupid = '${groupid}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from managerexp where managerid = '${managerid}' and groupid = '${groupid}'`,
                'bind': 'fund'
            }, {
                "sql": `select * from managerperformance where managerid = '${managerid}' and groupid = '${groupid}'`,
                'bind': 'fund'
            }, ]
            postSQLs(sqlBindList).done((queries) => {
                // 第一行第二张图
                renderFunc = (result) => {
                    var stockManagerSBoxData = {}

                    drawStyleBox({
                        placement: 'stockManagerSBoxPlacement',
                        xaxis: ['价值', '平衡', '成长'],
                        yaxis: ['小盘', '中盘', '大盘'],
                        timeline: result.map(e => e.reportdt),
                        ords: result.map(e => [e.growth_value, e.size])
                    });
                };
                renderFunc(queries[0]);

                // 2-1
                var fchart21 = (result) => {
                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金经理评价",
                            indicator = ["择时能力", "选股能力", "行业配置能力"],
                            limit = [0, 100],
                            timeticks = _.reverse(result.map(r => r.interval)),
                            values = _.reverse(result.map(r => [_.round(r.timing_rank), _.round(r.alpha_rank), _.round(r.indus_rank)])),
                            placement = "stock_manager_radar1",
                        ));
                    }
                    // 3-2
                var ftable32 = (result) => {

                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = ['timing_rank', 'indus_rank', 'alpha_rank', 'timing_coef', 'indus_coef', 'alpha_coef'];
                    const xlabel = ['择时能力得分', '行业配置能力得分', '选股能力得分', '择时项系数', '行业配置收益(年化)', '选股收益(年化)'];
                    var dataframe = [],
                        tableIndex = 1;

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = result.filter(r => r['interval'] == yindex[i])
                        if (fil.length) {
                            r = fil[0];
                            dataframe.push([ylabel[i]]);
                            for (var j = 0; j < xindex.length; j++) {
                                dataframe[dataframe.length - 1].push(r[xindex[j]]);
                            }
                        }
                    };
                    $(`#stockManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    if (result.length) {
                        fchart21(result);
                        ftable32(result)
                    }
                }
                renderFunc(queries[1]);

                // 2-2
                var fchart22 = (result) => {
                        var indicators = ["Size", "Beta", "Volatility", "Liquidity", "Value", "Certainty", "Cubic size", "Trend", "Growth", "SOE"];
                        var timeticks = [],
                            dataframe = [];
                        _.forIn(_.groupBy(result, 'reportdt'), function(records, dt) {
                            timeticks.push(dt);
                            var entry = _.fromPairs(records.map(r => [r.factorname, _.round(r.port, 2)]));
                            dataframe.push(indicators.map(e => entry[e]));
                        })
                        drawTimelineRadar(new TimeLineDataset(
                            title = "因子风格暴露",
                            indicators = indicators,
                            limit = [-1.6644, 1.5586],
                            timeticks = timeticks,
                            values = dataframe,
                            placement = "stock_manager_radar2",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));
                    }
                    // 2-3
                var fchart23 = (result) => {
                        var indicators = industries;
                        var timeticks = [],
                            dataframe = [];
                        _.forIn(_.groupBy(result, 'reportdt'), function(records, dt) {
                            timeticks.push(dt);
                            var entry = _.fromPairs(records.map(r => [r.factorname, _.round(r.port, 2)]));
                            dataframe.push(indicators.map(e => entry[e]));
                        })
                        drawTimelineRadar(new TimeLineDataset(
                            title = "行业风格暴露",
                            indicators = industry_labels,
                            limit = [0, 0.27777],
                            timeticks = timeticks,
                            values = dataframe,
                            placement = "stock_manager_radar3",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));
                    }
                    // 3-3
                var ftable33 = (result) => {
                        var tableIndex = 2,
                            dataframe = [];
                        const xlabel = ["Size", "Beta", "Volatility", "Liquidity", "Value", "Certainty", "Cubic size", "Trend", "Growth", "SOE"];
                        // 以时间进行group，value为label对应的数据
                        _.forOwn(_.groupBy(result, 'reportdt'), (records, dt) => {
                            const factorKV = _.fromPairs(records.map(r => [r.factorname, r.port]))
                            dataframe.push([dt, ...xlabel.map(x => factorKV[x])])
                        });
                        $(`#stockManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                            header: [' ', ...xlabel],
                            values: dataframe
                        }));

                    }
                    // 3-4
                var ftable34 = (result) => {
                    var tableIndex = 3,
                        dataframe = [];
                    const xlabel = industries;
                    // 以时间进行group，value为label对应的数据
                    _.forOwn(_.groupBy(result, 'reportdt'), (records, dt) => {
                        const factorKV = _.fromPairs(records.map(r => [r.factorname, r.port]))
                        dataframe.push([dt, ...xlabel.map(x => factorKV[x])])
                    });
                    $(`#stockManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...industry_labels],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    if (result.length) {
                        fchart22(result);
                        fchart23(result);
                        ftable33(result);
                        ftable34(result)
                    }
                }
                renderFunc(queries[2]);

                // 3-1
                renderFunc = (result) => {

                    var y = moment().year();
                    const yindex = ['lastdt', '5dt', '1m', '3m', '6m', '12m', '36m', '60m', 'ytd', 'setupdt', 'y-1', 'y-2', 'y-3', 'y-4', 'y-5'];
                    const ylabel = ['最新交易日', '最近5个交易日', '最近1个月', '最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '年初至今', '成立以来', y - 1 + '', y - 2 + '', y - 3 + '', y - 4 + '', y - 5 + ''];
                    const xindex = ['rank', 'cumret', 'annret', 'annvol', 'annsharpe', 'maxdd'];
                    const xlabel = ['累计收益同类排名', '累计收益', '年化收益', '年化波动率', '年化夏普比率', '最大回撤'];
                    var dataframe = [];
                    var tableIndex = 0;

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = result.filter(r => r['interval'] == yindex[i])
                        if (fil.length) {
                            r = fil[0];
                            dataframe.push([ylabel[i]]);
                            for (var j = 0; j < xindex.length; j++) {
                                var element = r[xindex[j]];
                                if (['cumret', 'annret', 'annvol', 'maxdd'].includes(xindex[j])) {
                                    element = fp(element)
                                }; //百分比形式
                                if (['annsharpe'].includes(xindex[j])) {
                                    element = f2(element) + ''
                                } //两位小数
                                dataframe[dataframe.length - 1].push(element);
                            }
                        }
                    };
                    $(`#stockManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc(queries[3]);

                // 使得table可以排序
                makeSortable("#stockManagerMulti table")
                    // 行业的header设置得宽一点
                $(`#stockManagerMulti .table-responsive-lg:nth(3) .tablesorter-header-inner`).css({
                    'width': '4em'
                })
            })
        }

        // 债券基金 筛选
        function filterBondProduct(searchInput) {
            validResult = bondProductInfoAll.filter(e => (e.fundcode + e.fundname + e.lastmanager).includes(searchInput));
            $('#bondProductSelect').empty().append((validResult.map(e => `<option value="${e.fundcode}">${e.fundcode}-${e.fundname}-${e.lastmanager}</option>`).join('')));
            if (validResult.length > 1) {
                $('#bondProductSelectAddon').text(validResult.length + '个结果，下拉选择')
            } else if (validResult.length == 1) {
                $('#stockProductSelectAddon').text('1个结果，已显示');
                displayBondProductInfo(validResult[0].fundcode)
            } else {
                $('#bondProductSelectAddon').text('无结果')
            }
        }
        // 债券基金 画图画表
        function displayBondProductInfo(fundcode) {
            bindDB = 'fund_bond';

            // 1-1
            var r = bondProductInfoAll.filter(e => e.fundcode == fundcode)[0];
            createBondFundInfo({
                names: ["基金名称", "基金公司", "Wind基金类型", "成立时间", "现任基金经理", "现任基金经理平均从业年限", "基金经理更换次数",
                    "基金经理获金牛奖次数", "最新规模（合计）", "所在公司主动管理规模", "所在公司规模（剔除货币型基金）", "Wind基准", "管理费率(%)", "数据截止时间"
                ],
                values: [r.fundname, r.compname, r.lastsector, r.setupdate, r.lastmanager, _.round(r.avgworklen, 1) + '年', r.changefreq,
                    r.awardnum, _.round(r.totalasset / 1e8, 2) + '亿', _.round(r.active / 1e8, 2) + '亿', _.round(r.total_excmoney / 1e8, 2) + '亿', r.benchmark, r.managefee, r.lastdt
                ],
                placement: 'bond_fund_info',
            });
            $('#bond_fund_info td').each((index, element) => {
                if (element.innerText.includes('NaN')) {
                    element.innerText = ''
                }
            })

            sqlBindList = [{
                    "sql": `select * from fundrank where fundcode = '${fundcode}'`,
                    'bind': 'fund_bond'
                }, {
                    "sql": `select * from marketexp`,
                    'bind': 'fund_bond'
                }, {
                    "sql": `select * from fundperformance where fundcode = '${fundcode}'`,
                    'bind': 'fund_bond'
                },

            ]
            postSQLs(sqlBindList).done((queries) => {
                // 2-1
                var fchart21 = (result) => {

                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "credit", "convert", "timing", "const"];
                        const orderedIndicators = ['久期配置', '信用配置', '可转债配置', '择时能力', '持有收益'];
                        const groupedRecords = _.groupBy(result, 'section')
                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['rank'], 2)]));
                                return factorNames.map(e => entry[e]);
                            })


                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金评价",
                            indicators = orderedIndicators,
                            limit = [0, 100],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_product_radar1",
                        ));

                    }
                    // 2-2
                var fchart22 = (result) => {

                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "twist", "butterfly", "credit", "convert"];
                        const OrderedIndicators = ["Shift", "Twist", "Butterfly", "Credit", "Convertible"];
                        const groupedRecords = _.groupBy(result, 'section')
                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['coef'], 2)]));
                                return factorNames.map(e => entry[e]);
                            })

                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金风格暴露",
                            indicators = OrderedIndicators,
                            limit = [-5.26, 5.44],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_product_radar2",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));

                    }
                    // 3-2
                var ftable32 = (result) => {

                        var y = moment().year();
                        const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                        const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                        const xindex = [
                            ['r2', 'coef'],
                            ['timing', 'rank'],
                            ['shift', 'rank'],
                            ['credit', 'rank'],
                            ['convert', 'rank'],
                            ['const', 'rank'],
                            ['timing', 'coef'],
                            ['shift', 'coef'],
                            ['credit', 'coef'],
                            ['convert', 'coef'],
                            ['const', 'coef']
                        ];
                        const xlabel = ['拟合度R2', '择时能力得分', '久期配置得分', '信用配置得分', '可转债配置得分', '持有收益得分', '择时项系数', '久期配置收益', '信用配置收益', '可转债配置收益', '持有收益'];
                        var dataframe = [];
                        var tableIndex = 1;

                        for (var i = 0; i < yindex.length; i++) {
                            const fil = result.filter(r => r['section'] == yindex[i])
                            if (!fil.length) {
                                continue
                            } else {
                                dataframe.push([ylabel[i]]);
                                for (var j = 0; j < xindex.length; j++) {
                                    var factorName = xindex[j][0];
                                    var attr = xindex[j][1];
                                    const selected = fil.filter(r => r['factorname'] == factorName)[0];
                                    var element = selected[attr];
                                    if (['shift', 'credit', 'convert', 'const'].includes(factorName) && attr == 'coef') {
                                        element = _.round(element * 100, 2) + '%'
                                    } else {
                                        element = _.round(element, 2) + ''
                                    }
                                    dataframe[dataframe.length - 1].push(element);
                                }
                            }
                        }
                        $(`#bondProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                            header: [' ', ...xlabel],
                            values: dataframe
                        }));
                    }
                    // 3-3
                var ftable33 = (result) => {
                    var tableIndex = 2,
                        dataframe = [];
                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = [
                        ['shift', 'coef'],
                        ['twist', 'coef'],
                        ['butterfly', 'coef'],
                        ['credit', 'coef'],
                        ['convert', 'coef']
                    ];
                    const xlabel = ['Shift', 'Twist', 'Butterfly', 'Credit', 'Convert'];

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = _.filter(result, ['section', yindex[i]])
                            // 如果没有这个年份，跳过就好
                        if (!fil.length) {
                            continue
                        }
                        // 把年份的label加入，为第1列
                        dataframe.push([ylabel[i]]);
                        // 把符合要求的value插进dataframe
                        for (var j = 0; j < xindex.length; j++) {
                            const [factorName, attr] = xindex[j];
                            const selected = _.find(fil, ['factorname', factorName]);
                            const element = _.round(selected[attr], 2) + ''
                            _.nth(dataframe, -1).push(element);
                        }
                    }
                    $(`#bondProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    if (result.length) {
                        fchart21(result);
                        fchart22(result);
                        ftable32(result);
                        ftable33(result);
                    }
                }
                renderFunc(queries[0]);

                // 2-3
                var fchart23 = (result) => {

                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "twist", "butterfly", "credit", "convert"];
                        const OrderedIndicators = ["Shift", "Twist", "Butterfly", "Credit", "Convertible"];
                        const groupedRecords = _.groupBy(result, 'section')

                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['marketexp'], 2)]));
                                return factorNames.map(e => entry[e]);
                            })

                        drawTimelineRadar(new TimeLineDataset(
                            title = "全市场风格暴露",
                            indicators = OrderedIndicators,
                            limit = [-5.26, 5.44],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_product_radar3",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));


                    }
                    // 3-4
                var ftable34 = (result) => {
                    var tableIndex = 3,
                        dataframe = [];
                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = [
                        ['shift', 'marketexp'],
                        ['twist', 'marketexp'],
                        ['butterfly', 'marketexp'],
                        ['credit', 'marketexp'],
                        ['convert', 'marketexp']
                    ];
                    const xlabel = ['Shift', 'Twist', 'Butterfly', 'Credit', 'Convert'];

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = _.filter(result, ['section', yindex[i]])
                            // 如果没有这个年份，跳过就好
                        if (!fil.length) {
                            continue
                        }
                        // 把年份的label加入，为第1列
                        dataframe.push([ylabel[i]]);
                        // 把符合要求的value插进dataframe
                        for (var j = 0; j < xindex.length; j++) {
                            const [factorName, attr] = xindex[j];
                            const selected = _.find(fil, ['factorname', factorName]);
                            const element = _.round(selected[attr], 2) + ''
                            _.nth(dataframe, -1).push(element);
                        }
                    }
                    $(`#bondProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    fchart23(result);
                    ftable34(result)
                }
                renderFunc(queries[1]);

                // 3-1
                renderFunc = (result) => {

                    var y = moment().year();
                    const yindex = ['lastdt', '5dt', '1m', '3m', '6m', '12m', '36m', '60m', 'ytd', 'setupdt', 'y-1', 'y-2', 'y-3', 'y-4', 'y-5'];
                    const ylabel = ['最新交易日', '最近5个交易日', '最近1个月', '最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '年初至今', '成立以来', y - 1 + '', y - 2 + '', y - 3 + '', y - 4 + '', y - 5 + ''];
                    const xindex = ['rank', 'cumret', 'annret', 'annvol', 'annsharpe', 'maxdd'];
                    const xlabel = ['累计收益同类排名', '累计收益', '年化收益', '年化波动率', '年化夏普比率', '最大回撤'];
                    var dataframe = [];
                    var tableIndex = 0;

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = result.filter(r => r['interval'] == yindex[i])
                        if (!fil.length) {
                            continue
                        } else {
                            r = fil[0];
                            dataframe.push([ylabel[i]]);
                            for (var j = 0; j < xindex.length; j++) {
                                var element = r[xindex[j]];
                                if (['cumret', 'annret', 'annvol', 'maxdd'].includes(xindex[j])) {
                                    element = _.round(element * 100, 2) + '%'
                                }; //百分比形式
                                if (['annsharpe'].includes(xindex[j])) {
                                    element = _.round(element, 2) + ''
                                } //两位小数
                                dataframe[dataframe.length - 1].push(element);
                            }
                        }
                    }
                    $(`#bondProductMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc(queries[2]);

                // 使得table可以排序
                makeSortable("#bondProductMulti table")
            })
        }

        // 债券经理 筛选
        function filterBondManager(searchInput) {
            validResult = bondManagerInfoAll.filter(e => ('' + e.name + e.gender + e.edu + e.compname + e.maxasset).includes(searchInput));
            $('#bondManagerSelect').empty().append((validResult.map(e => `<option value="${e.managerid},${e.groupid}">${e.name}-\
               ${e.gender}-${e.edu}-${e.compname}-${e.maxasset}-${groupidMap[e.groupid]}</option>`).join('')));
            if (validResult.length > 2) {
                $('#bondManagerSelectAddon').text(validResult.length + '个结果，下拉选择')
            } else if (validResult.length == 2) {
                $('#bondManagerSelectAddon').text('2个结果，已显示其一');
                displayBondManagerInfo(`${validResult[0].managerid},${validResult[0].groupid}`)
            } else {
                $('#bondManagerSelectAddon').text('无结果')
            }
        }
        // 债券经理 画图画表
        function displayBondManagerInfo(selectedValue) {
            var [managerid, groupid] = selectedValue.split(',');

            // 1-1
            var r = bondManagerInfoAll.filter(e => e.managerid == managerid)[0];
            createFundInfo({
                x: ["姓名", "性别", "学历", "公募从业年限", "公募历任公司数", "当前管理的同类产品个数", "历史管理的同类产品个数",
                    "当前管理的同类产品中规模最大的基金", "当前管理的同类产品规模", "当前管理的所有产品规模",
                    "所在公司主动管理规模", "所在公司规模（剔除货币型基金）", "获金牛奖次数", "数据截止时间"
                ],
                y: [r.name, r.gender, r.edu, _.round(r.worklen, 1) + '年', _.round(r.jobfreq), r.lastfundnum, r.hisfundnum,
                    r.maxasset, _.round(r.totalasset1 / 1e8, 2) + '亿', _.round(r.totalasset2 / 1e8, 2) + '亿',
                    _.round(r.active / 1e8, 2) + '亿', _.round(r.total_excmoney / 1e8, 2) + '亿', r.awardnum, r.lastdt
                ],
                chart: $('#bondManagerProfile').get(0),
            });
            $('#bondManagerProfile td').each((index, element) => {
                if (element.innerText.includes('NaN')) {
                    element.innerText = ''
                }
            })

            sqlBindList = [{
                    "sql": `select * from managerrank where managerid = '${managerid}' and groupid = '${groupid}'`,
                    'bind': 'fund_bond'
                }, {
                    "sql": `select * from marketexp`,
                    'bind': 'fund_bond'
                }, {
                    "sql": `select * from managerperformance where managerid = '${managerid}' and groupid = '${groupid}'`,
                    'bind': 'fund_bond'
                },

            ]
            postSQLs(sqlBindList).done((queries) => {

                // 2-1
                var fchart21 = (result) => {
                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "credit", "convert", "timing", "const"];
                        const orderedIndicators = ['久期配置', '信用配置', '可转债配置', '择时能力', '持有收益'];
                        const groupedRecords = _.groupBy(result, 'section')
                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['rank'], 2)]));
                                return factorNames.map(e => entry[e]);
                            }
                        )

                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金经理评价",
                            indicators = orderedIndicators,
                            limit = [0, 100],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_manager_radar1",
                        ));

                    }
                    // 2-2 
                var fchart22 = (result) => {
                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "twist", "butterfly", "credit", "convert"];
                        const OrderedIndicators = ["Shift", "Twist", "Butterfly", "Credit", "Convertible"];
                        const groupedRecords = _.groupBy(result, 'section')
                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['coef'], 2)]));
                                return factorNames.map(e => entry[e]);
                            })

                        drawTimelineRadar(new TimeLineDataset(
                            title = "基金经理因子暴露",
                            indicators = OrderedIndicators,
                            limit = [-5.97, 6.53],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_manager_radar2",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));

                    }
                    // 3-2
                var ftable32 = (result) => {

                        var y = moment().year();
                        const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                        const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                        const xindex = [
                            ['r2', 'coef'],
                            ['timing', 'rank'],
                            ['shift', 'rank'],
                            ['credit', 'rank'],
                            ['convert', 'rank'],
                            ['const', 'rank'],
                            ['timing', 'coef'],
                            ['shift', 'coef'],
                            ['credit', 'coef'],
                            ['convert', 'coef'],
                            ['const', 'coef']
                        ];
                        const xlabel = ['拟合度R2', '择时能力得分', '久期配置得分', '信用配置得分', '可转债配置得分', '持有收益得分', '择时项系数', '久期配置收益', '信用配置收益', '可转债配置收益', '持有收益'];
                        var dataframe = [];
                        var tableIndex = 1;

                        for (var i = 0; i < yindex.length; i++) {
                            const fil = result.filter(r => r['section'] == yindex[i])
                            if (!fil.length) {
                                continue
                            } else {
                                dataframe.push([ylabel[i]]);
                                for (var j = 0; j < xindex.length; j++) {
                                    var factorName = xindex[j][0];
                                    var attr = xindex[j][1];
                                    const selected = fil.filter(r => r['factorname'] == factorName)[0];
                                    var element = selected[attr];
                                    if (['shift', 'credit', 'convert', 'const'].includes(factorName) && attr == 'coef') {
                                        element = _.round(element * 100, 2) + '%'
                                    } else {
                                        element = _.round(element, 2) + ''
                                    }
                                    dataframe[dataframe.length - 1].push(element);
                                }
                            }
                        }
                        $(`#bondManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                            header: [' ', ...xlabel],
                            values: dataframe
                        }));
                    }
                    // 3-3
                var ftable33 = (result) => {
                    var tableIndex = 2,
                        dataframe = [];
                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = [
                        ['shift', 'coef'],
                        ['twist', 'coef'],
                        ['butterfly', 'coef'],
                        ['credit', 'coef'],
                        ['convert', 'coef']
                    ];
                    const xlabel = ['Shift', 'Twist', 'Butterfly', 'Credit', 'Convert'];

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = _.filter(result, ['section', yindex[i]])
                            // 如果没有这个年份，跳过就好
                        if (!fil.length) {
                            continue
                        }
                        // 把年份的label加入，为第1列
                        dataframe.push([ylabel[i]]);
                        // 把符合要求的value插进dataframe
                        for (var j = 0; j < xindex.length; j++) {
                            const [factorName, attr] = xindex[j];
                            const selected = _.find(fil, ['factorname', factorName]);
                            const element = _.round(selected[attr], 2) + ''
                            _.nth(dataframe, -1).push(element);
                        }
                    }
                    $(`#bondManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    fchart21(result);
                    fchart22(result);
                    ftable32(result);
                    ftable33(result);
                }
                renderFunc(queries[0]);

                // 2-3
                var fchart23 = (result) => {
                        const orderedTimeticks = _.reverse([...new Set(result.map(r => r['section']))]);
                        const factorNames = ["shift", "twist", "butterfly", "credit", "convert"];
                        const OrderedIndicators = ["Shift", "Twist", "Butterfly", "Credit", "Convertible"];
                        const groupedRecords = _.groupBy(result, 'section')
                        const dataframe = orderedTimeticks.map(
                            function(tt) {
                                const entry = _.fromPairs(groupedRecords[tt].map(r => [r['factorname'], _.round(r['marketexp'], 2)]));
                                return factorNames.map(e => entry[e]);
                            })

                        drawTimelineRadar(new TimeLineDataset(
                            title = "全市场风格暴露",
                            indicators = OrderedIndicators,
                            limit = [-5.97, 6.53],
                            timeticks = orderedTimeticks,
                            values = dataframe,
                            placement = "bond_manager_radar3",
                            subTitle = '坐标上下限为0.99分位和0.01分位',
                        ));
                    }
                    // 3-4
                var ftable34 = (result) => {
                    var tableIndex = 3,
                        dataframe = [];
                    const yindex = ['last3m', 'last6m', 'last1y', 'last3y', 'last5y', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const ylabel = ['最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '2021', '2020', '2019', '2018', '2017', '2016', '2015', '2014', '2013', '2012', '2011'];
                    const xindex = [
                        ['shift', 'marketexp'],
                        ['twist', 'marketexp'],
                        ['butterfly', 'marketexp'],
                        ['credit', 'marketexp'],
                        ['convert', 'marketexp']
                    ];
                    const xlabel = ['Shift', 'Twist', 'Butterfly', 'Credit', 'Convert'];

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = _.filter(result, ['section', yindex[i]])
                            // 如果没有这个年份，跳过就好
                        if (!fil.length) {
                            continue
                        }
                        // 把年份的label加入，为第1列
                        dataframe.push([ylabel[i]]);
                        // 把符合要求的value插进dataframe
                        for (var j = 0; j < xindex.length; j++) {
                            const [factorName, attr] = xindex[j];
                            const selected = _.find(fil, ['factorname', factorName]);
                            const element = _.round(selected[attr], 2) + ''
                            _.nth(dataframe, -1).push(element);
                        }
                    }
                    $(`#bondManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc = (result) => {
                    fchart23(result);
                    ftable34(result);
                }
                renderFunc(queries[1]);

                // 3-1
                renderFunc = (result) => {

                    var y = moment().year();
                    const yindex = ['lastdt', '5dt', '1m', '3m', '6m', '12m', '36m', '60m', 'ytd', 'setupdt', 'y-1', 'y-2', 'y-3', 'y-4', 'y-5'];
                    const ylabel = ['最新交易日', '最近5个交易日', '最近1个月', '最近3个月', '最近6个月', '最近1年', '最近3年', '最近5年', '年初至今', '成立以来', y - 1 + '', y - 2 + '', y - 3 + '', y - 4 + '', y - 5 + ''];
                    const xindex = ['rank', 'cumret', 'annret', 'annvol', 'annsharpe', 'maxdd'];
                    const xlabel = ['累计收益同类排名', '累计收益', '年化收益', '年化波动率', '年化夏普比率', '最大回撤'];
                    var dataframe = [];
                    var tableIndex = 0;

                    for (var i = 0; i < yindex.length; i++) {
                        const fil = result.filter(r => r['interval'] == yindex[i])
                        if (!fil.length) {
                            continue
                        } else {
                            r = fil[0];
                            dataframe.push([ylabel[i]]);
                            for (var j = 0; j < xindex.length; j++) {
                                var element = r[xindex[j]];
                                if (['cumret', 'annret', 'annvol', 'maxdd'].includes(xindex[j])) {
                                    element = _.round(element * 100, 2) + '%'
                                }; //百分比形式
                                if (['annsharpe'].includes(xindex[j])) {
                                    element = _.round(element, 2) + ''
                                } //两位小数
                                dataframe[dataframe.length - 1].push(element);
                            }
                        }
                    };
                    $(`#bondManagerMulti .table-responsive-lg:nth(${tableIndex})`).html(createTable({
                        header: [' ', ...xlabel],
                        values: dataframe
                    }));
                }
                renderFunc(queries[2]);

                // 使得table可以排序
                makeSortable("#bondManagerMulti table")
            })

        }

        // 基金组合跟踪 筛选
        function onPortSelect() {
            var portcode = $('#portfolio_select').val();
            var hp = $('#tiaocangpinlv').val()
            renderPortPage(portcode, hp);
        }
        // 基金组合跟踪 选择指定日期的推荐名单

        let port_dataset = {
                header: ['基金代码', '基金简称', '基金类型', '基金经理', '成立日期', '选股能力', '夏普比率', '最大回撤', '逆境收益率', '基金规模', '基金经理变更次数', '管理人份额持有占比', 'zscore'],
                dataframe: {},
                selectPlacement: 'fundRecommSelect',
                placement: 'fundRecommTableMulti'
            }
            // 基金组合跟踪 画图画表
        function renderPortPage(portcode, hp) {



            sqlBindList = [{
                "sql": `select * from portindicator where (portcode='${portcode}' and hp='${hp}')`,
                'bind': 'fund'
            }, {
                "sql": `select * from portnav where (portcode='${portcode}' and hp='${hp}')`,
                'bind': 'fund'
            }, {
                "sql": `select * from portyearret where (portcode='${portcode}' and hp='${hp}')`,
                'bind': 'fund'
            }, {
                "sql": `select RANK() OVER (PARTITION BY tradingdate ORDER BY zscore DESC) AS rank,* from portpositions where (portcode='${portcode}' and hp='${hp}')`,
                'bind': 'fund'
            }, ]
            postSQLs(sqlBindList).done((queries) => {

                renderFunc = (result) => {
                    var header = ['年化收益率', '年化超额收益', '年化波动率', '最大回撤', '年化夏普比', '年化信息比', '季度胜率', '年化换手率（单边）']
                    var r = result[0];
                    var vals = [fp(r.annret), fp(r.activeret), fp(r.vol), fp(r.maxdd), f2(r.sharpe), f2(r.ir), fp(r.winrate), f2(r.turnover)]
                    var greeks = {
                        names: header,
                        values: vals,
                        placement: 'portGreeks',
                    };
                    insertGreekTable(greeks);
                }
                renderFunc(queries[0])

                renderFunc = (result) => {
                    var benchLineData = {
                        placement: 'benchmarkLine',
                        x: [],
                        y1: [],
                        y2: []
                    };
                    for (const r of _.sortBy(result, function(o) {
                            return o.tradingdate;
                        })) {
                        benchLineData.x.push(r['tradingdate']);
                        benchLineData.y1.push(r['portnav']);
                        benchLineData.y2.push(r['benchnav']);
                    }
                    drawLineVsBench(benchLineData);
                }
                renderFunc(queries[1])

                renderFunc = (result) => {
                    var benchLineData = {
                        placement: 'benchmarkBar',
                        x: [],
                        y1: [],
                        y2: []
                    };
                    for (const r of result) {
                        benchLineData.x.push(r['year']);
                        benchLineData.y1.push(r['portret']);
                        benchLineData.y2.push(r['benchret']);
                    }
                    drawBarVsBench(benchLineData);
                }
                renderFunc(queries[2])

                // 下拉框和表
                renderFunc = (result) => {

                    // 
                    port_dataset = {
                        header: ['序号', '基金代码', '基金简称', '基金类型', '基金经理', '成立日期', '选股能力', '夏普比率', '最大回撤', '逆境收益率', '基金规模', '基金经理变更次数', '管理人份额持有占比', 'zscore'],
                        dataframe: {},
                        selectPlacement: 'fundRecommSelect',
                        placement: 'fundRecommTableMulti'
                    }

                    // 以推荐时间进行group，key为selection，value为port_dataset的数据
                    _.forOwn(_.groupBy(result, 'tradingdate'), (value, key) => {
                        // 按照zscore排序，从大到小
                        port_dataset.dataframe[key] = _.sortBy(value, function(o) {
                            return -o.zscore;
                        }).map(
                            r => [r['rank'], r['fundcode'], r['fundname'], r['lastsector'], r['lastmanager'],
                                r['setupdate'], f2(r['111']), f2(r['204']), f2(r['304']), f2(r['410']),
                                f2(r['501']), r['601'], _.round(r['703'], 3), r['zscore']
                            ]
                        )
                    });

                    // 插入推荐日期下拉框选项
                    var selectNode = $(`#${port_dataset.selectPlacement}`).empty();
                    selectNode.append($(_.keys(port_dataset.dataframe).sort((a, b) => b - a).map(e => `<option value="${e}">${e}</option>`).join('')));

                    tmp = port_dataset;
                    const refreshRecomm = (port_dataset0, key) => {
                        $(`#${port_dataset0.placement}`).html(createTable({
                            header: port_dataset0.header,
                            values: port_dataset0.dataframe[key]
                        }));
                    }
                    selectNode.change(function() {


                        console.log(port_dataset.dataframe);

                        refreshRecomm(port_dataset, this.value);


                        $(`#${port_dataset.placement}`).html(createTable({
                            header: port_dataset.header,
                            values: port_dataset.dataframe[this.value]
                        }));
                        console.log(this.value);

                        makeSortable("#fundRecommTableMulti table");
                    });

                    // 插入目前的selection的表格
                    refreshRecomm(port_dataset, selectNode.val());
                    makeSortable("#fundRecommTableMulti table");

                }
                renderFunc(queries[3]);


            })
        }
    </script>
</head>

<body>
    <!-- 导航栏 -->
    <div class="container-fluid">
        <nav class="navbar navbar-light  border-bottom border-warning sticky-top justify-content-center">

            <div class="col-2">
                <a class="nav-link h4" href="#" style="text-align:center" onclick="showApp('auth_app');$('#factorCollapse').collapse('hide');$('#fofCollapse').collapse('hide')">
                    东方金工
                </a>
            </div>

            <a class="nav-link h4" data-toggle="collapse" aria-expanded="true" href="#factorCollapse" onclick="$('#fofCollapse').collapse('hide')">
                股票因子
            </a>
            <a class="nav-link h4" data-toggle="collapse" aria-expanded="true" href="#fofCollapse" onclick="$('#factorCollapse').collapse('hide')">
                FOF投资
            </a>
            <a class="nav-link h4" href="#" onclick="showApp('updatelog_app')">
                更新日志
            </a>
            <div class="h4 navbar-text ml-auto" style="align-content: flex-end;color:#DAA620;">DFQ量化分析工具</div>


        </nav>
        <br>

        <div class="collapse" id="factorCollapse">

            <div class="row">
                <div class="col-2"></div>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('factorinfo_app');showSubApp('single_factor_dashboard');$('#factorCollapse').collapse('hide')">单因子跟踪</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('factorinfo_app');showSubApp('multi_factor_recent');$('#factorCollapse').collapse('hide')">多因子近期表现</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('factorinfo_app');showSubApp('multi_factor_interval');$('#factorCollapse').collapse('hide')">多因子区间表现</a>
                </ul>
            </div>
            <hr style="background-color:gold">

        </div>

        <div class="collapse" id="fofCollapse">

            <div class="row">
                <div class="col-2"></div>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('fofinfo_app');showSubApp('fofinfo_stock_product');$('#fofCollapse').collapse('hide')">基金产品分析-股票</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('fofinfo_app');showSubApp('fofinfo_stock_manager');$('#fofCollapse').collapse('hide')">基金经理分析-股票</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('fofinfo_app');showSubApp('fofinfo_bond_product');$('#fofCollapse').collapse('hide')">基金产品分析-债券</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('fofinfo_app');showSubApp('fofinfo_bond_manager');$('#fofCollapse').collapse('hide')">基金经理分析-债券</a>
                </ul>
                <ul class="nav-item">
                    <a class="btn btn-outline-warning" href="#" onclick="showApp('fofinfo_app');showSubApp('fofinfo_portfolio_track');$('#fofCollapse').collapse('hide')">基金组合跟踪</a>
                </ul>
            </div>
            <hr style="background-color:gold">

        </div>
    </div>


    <!-- 界面：登录 -->
    <div class="container-fluid" id="auth_app" style="height: 700px;">
        <div class="row justify-content-center" style="position:ralative; height: 90%;">

            <form class="align-self-center">
                <br><br>
                <div style="text-align: center;">
                    <i class='fas fa-user' style='font-size:100px;color:#DAA620;'></i>
                </div>
                <br><br>

                <input id="inputEmail" class="form-control" style="border-color: #E7C56F;" required autofocus><br>
                <input id="inputPassword" class="form-control" style="border-color: #E7C56F;" type="password" required><br>

                <button type="button" class="btn btn-outline-warning form-control" id="loginBtn">登录</button>
            </form>
        </div>
        <div class="row justify-content-center" style="position:ralative; height: 20%;">
            <div class="blockquote text-center" style="color: #DAA620;">
                <b style="font-family: Arial, Helvetica, sans-serif;font-size: 3em;">
                    Alpha = Logic + Tech + Luck
                </b>
            </div>
        </div>

        <hr style="background-color:gold">
        <div class="row">

            <div class="col-2">
                <p style="text-align: center; color:#E7C56F  ;font-family: Impact;">
                    <b style="font-size: 22px">东方证券股份有限公司</b><br>
                    <small style="font-size: 15px">ORIENT SECURITIES COMPANY LIMITED</small>
                </p>
            </div>

            <div class="col-8">
                <p style="color: #c61b1bac;text-align:center;">
                    <b>本工具仅供东方证券研究所机构客户使用，用户名开设请联系对应机构销售和分析师。版权所有，翻版承担法律责任。</b>
                </p>
            </div>
            <div class="col-2">
                <h4 style="color: #E7C56F;text-align: center;">
                    版本：Ver 4.0.3
                </h4>
            </div>
        </div> <br><br><br><br><br><br><br> <br><br><br><br><br><br><br>
    </div>


    <!-- 界面：因子跟踪 -->
    <div class="container-fluid" id="factorinfo_app">
        <div class="container-fluid" id="single_factor_dashboard">
            <div class="row">
                <!-- 侧栏导航 -->
                <div class="col-2">
                    <div class="container-fluid" id="fFilter">
                        <div class="form-group">
                            <small class="form-text text-muted">开始时间</small>
                            <input class="form-control input-group date" type="text" value="2020-01-01">
                        </div>

                        <div class="form-group">
                            <small class="form-text text-muted">结束时间</small>
                            <input class="form-control input-group date" type="text" value="2021-04-01">
                        </div>

                        <div class="form-group">
                            <small class="form-text text-muted">风格中性化</small>
                            <select class="form-control">
                                <option value=1>是</option>
                                <option value=0>否</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <small class="form-text text-muted">选样空间</small>
                            <select class="form-control">
                                <option>沪深300</option>
                                <option>中证1000</option>
                                <option>中证500</option>
                                <option>中证800</option>
                                <option>中证全指</option>
                            </select>
                            <small class="form-text text-muted">（点击因子使参数生效）</small>
                        </div>

                    </div>
                    <nav class="bg-light position-sticky pt-3">
                        <ul class="nav flex-column" id="factorCategory"></ul>
                    </nav>
                </div>
                <div class="col-10">
                    <div class="row justify-content-around">
                        <div id="factorIntro" style="text-align: left; width:100%;height:150px;">
                            <h3 class="display-6" style="padding-left: 5em;"></h3>
                            <hr>
                        </div>
                    </div>
                    <!-- 第一行、一图一表 -->
                    <div class="row justify-content-around">
                        <div class="col-8">
                            <div id="bucketExRet" style="width:100%;height:350px;"></div>
                        </div>
                        <div class="col-3">
                            <h4 style="text-align: center;vertical-align:middle;" id="factorPerfTableHead"></h4>
                            <div class="table table-striped table-responsive-sm" id="factorPerfTable"> </div>
                        </div>
                    </div>
                    <hr>
                    <!-- 第二行、一张图 -->
                    <div class="row justify-content-around">
                        <div class="col-11">
                            <div id="monPerf" style="width:100%;height:350px;"></div>
                        </div>
                    </div>
                    <hr>
                    <!-- 第三行、一张图 -->
                    <div class="row justify-content-around">
                        <div class="col-11">
                            <div id="netDD" style="width:100%;height:350px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid" id="multi_factor_recent">


            <div class="row justify-content-center" id="multi_factor_recent_filter">

                <div class="input-group mb-3 col-3">
                    <div class="input-group-prepend"> <span class="input-group-text">风格中性化</span> </div>
                    <select class="form-control">
                        <option value=1>是</option>
                        <option value=0>否</option>
                    </select>
                </div>
                <div class="input-group mb-3 col-3">
                    <div class="input-group-prepend"> <span class="input-group-text">选样空间</span> </div>
                    <select class="form-control">
                        <option>沪深300</option>
                        <option>中证1000</option>
                        <option>中证500</option>
                        <option>中证800</option>
                        <option>中证全指</option>
                    </select>
                </div>
                <div class="col-1 form-group">
                    <button class="btn btn-outline-warning" onclick="renderMultiFactorRecent();">确定</button>
                </div>

            </div>
            <div style="text-align:center;vertical-align:middle">
                <small style="color:rgba(96,96,96,.934);">
                    数据下载时间约10s。
                </small>
            </div>

            <br>
            <div class="row justify-content-around">

                <div class="col-5" id="multi_factor_week_div">
                    <div class="container">
                        <h4 style="color: #DAA620;">最近一周</h4>
                        <table id="multi_factor_week" class="table-striped">
                            <thead>
                                <tr>
                                    <th data-field="fname" data-sortable="true">因子名称</th>
                                    <th data-field="avgic" data-sortable="true">日均IC</th>
                                    <th data-field="icir" data-sortable="true">IC_IR</th>
                                    <th data-field="avgret" data-sortable="true">日均多空收益率</th>
                                    <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                    <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                    <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>

                <div class="col-5" id="multi_factor_month_div">
                    <div class="container">
                        <h4 style="color: #DAA620;">最近一月</h4>
                        <table id="multi_factor_month" class="table-striped">
                            <thead>
                                <tr>
                                    <th data-field="fname" data-sortable="true">因子名称</th>
                                    <th data-field="avgic" data-sortable="true">月度IC</th>
                                    <th data-field="icir" data-sortable="true">IC_IR</th>
                                    <th data-field="avgret" data-sortable="true">月度多空收益率</th>
                                    <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                    <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                    <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>

            </div>
            <br>
            <div class="row justify-content-around">
                <div class="col-5" id="multi_factor_quarter_div">
                    <div class="container">
                        <h4 style="color: #DAA620;">最近三月</h4>
                        <table id="multi_factor_quarter" class="table-striped">
                            <thead>
                                <tr>
                                    <th data-field="fname" data-sortable="true">因子名称</th>
                                    <th data-field="avgic" data-sortable="true">月均IC</th>
                                    <th data-field="icir" data-sortable="true">IC_IR</th>
                                    <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                    <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                    <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                    <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                </tr>
                            </thead>
                        </table>
                    </div>


                </div>

                <div class="col-5" id="multi_factor_semi_div">
                    <div class="container">
                        <h4 style="color: #DAA620;">最近六月</h4>
                        <table id="multi_factor_semi" class="table-striped">
                            <thead>
                                <tr>
                                    <th data-field="fname" data-sortable="true">因子名称</th>
                                    <th data-field="avgic" data-sortable="true">月均IC</th>
                                    <th data-field="icir" data-sortable="true">IC_IR</th>
                                    <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                    <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                    <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                    <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                                </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>

        </div>
        <div class="container-fluid" id="multi_factor_interval">


            <div class="row justify-content-center" id="multi_factor_interval_filter">

                <div class="input-group mb-3 col-3">
                    <div class="input-group-prepend"> <span class="input-group-text">开始时间</span> </div>
                    <input class="form-control input-group date" type="text" value="2020-01-01">
                </div>

                <div class="input-group mb-3 col-3">
                    <div class="input-group-prepend"> <span class="input-group-text">结束时间</span> </div>
                    <input class="form-control input-group date" type="text" value="2021-01-01">
                </div>

                <div class="input-group mb-3 col-2">
                    <div class="input-group-prepend"> <span class="input-group-text">风格中性化</span> </div>
                    <select class="form-control">
                        <option value=1>是</option>
                        <option value=0>否</option>
                    </select>
                </div>
                <div class="input-group mb-3 col-3">
                    <div class="input-group-prepend"> <span class="input-group-text">选样空间</span> </div>
                    <select class="form-control">
                        <option>沪深300</option>
                        <option>中证1000</option>
                        <option>中证500</option>
                        <option>中证800</option>
                        <option>中证全指</option>
                    </select>
                </div>
                <div class="col-1 form-group">
                    <button class="btn btn-outline-warning" onclick="renderMultiFactorInterval();">确定</button>
                </div>

            </div>

            <div class="row justify-content-center">

                <div class="col-11" id="multi_factor_interval_table_div">

                    <h4 style="text-align:center;color: #DAA620;">区间因子表现</h4>
                    <div style="text-align:center;vertical-align:middle">
                        <small style="color:rgba(96,96,96,.934);">
                            数据下载时间约10s。
                        </small>
                    </div>

                    <table id="multi_factor_interval_table" class="table-striped">
                        <thead>
                            <tr>
                                <th data-field="fname" data-sortable="true">因子名称</th>
                                <th data-field="avgic" data-sortable="true">月均IC</th>
                                <th data-field="icir" data-sortable="true">IC_IR</th>
                                <th data-field="avgret" data-sortable="true">月均多空收益率</th>
                                <th data-field="hitratio" data-sortable="true">多空组合胜率</th>
                                <th data-field="lsir" data-sortable="true">多空组合信息比</th>
                                <th data-field="maxdd" data-sortable="true">多空组合最大回撤</th>
                            </tr>
                        </thead>
                    </table>

                </div>


            </div>

        </div>
        <hr>
    </div>

    <!-- 界面：基金分析工具 -->
    <div class="container-fluid" id="fofinfo_app">
        <div class="row">


            <div class="container-fluid" id="fofinfo_stock_product">
                <!-- 基金代码的搜索框 -->
                <div class="row justify-content-around">
                    <input type="text" class="form-control col-4" placeholder="关键词回车搜索，比如：543、医药、杨" id="stockProductSearch" onchange="filterStockFund(this.value)">
                    <div class="input-group mb-3 col-6">
                        <div class="input-group-prepend"> <span class="input-group-text" id="stockProductSelectAddon">#</span> </div>
                        <select class="form-control" id="stockProductSelect" onchange="displayStockFundInfo(this.value);"></select>
                    </div>
                </div>
                <hr>
                <div class="row justify-content-center">
                    <div class="col-5">
                        <!-- 基金信息表 -->
                        <h4 style="text-align:center">基金信息</h4>
                        <div class="table-responsive-lg" id="stockProductInfoPlacement"> </div>
                    </div>
                    <!-- 风格小箱子 -->
                    <div class="col-4" id="stockProductSBoxPlacement" style="width:500px;height:400px"></div>
                    <!-- 最新一期基金打分 -->
                    <div class="col-3 radar" id="stockProductRatingRadarPlacement"></div>
                </div><br>
                <hr>
                <div class="row justify-content-around">
                    <div class="col radar" id="stock_product_radar1"></div>
                    <div class="col radar" id="stock_product_radar2"></div>
                    <div class="col radar" id="stock_product_radar3"></div>
                </div><br><br>
                <div id='stockProductMulti'>
                    <nav>
                        <div class="nav nav-tabs" role="tablist"></div>
                    </nav>

                    <div class="tab-content"></div>
                </div>
            </div>

            <div class="container-fluid" id="fofinfo_stock_manager">
                <!-- 基金经理的搜索框 -->
                <div class="row justify-content-around">
                    <input type="text" class="form-control col-4" placeholder="关键词回车搜索，比如：王、女、博士、中金、消费" id="stockManagerSearch" onchange="filterStockFundManager(this.value)">
                    <div class="input-group mb-3 col-6">
                        <div class="input-group-prepend"> <span class="input-group-text" id="stockManagerSelectAddon">#</span> </div>
                        <select class="form-control" id="stockManagerSelect" onchange="displayStockManagerInfo(this.value)"></select>
                    </div>
                </div>
                <hr>
                <div class="row justify-content-md-around">
                    <div class="col-5">
                        <!-- 基金信息表 -->
                        <h4 style="text-align:center">基金经理信息</h4>
                        <div class="table-responsive-lg" id="stock_manager_profile"></div>
                    </div>
                    <div class="col-5">
                        <!-- 风格小箱子 -->
                        <div id="stockManagerSBoxPlacement" style="width:500px;height:400px"></div>
                    </div>
                </div><br>
                <hr>
                <div class="row justify-content-around">
                    <div class="col radar" id="stock_manager_radar1"></div>
                    <div class="col radar" id="stock_manager_radar2"></div>
                    <div class="col radar" id="stock_manager_radar3"></div>
                </div><br><br>

                <div id='stockManagerMulti'>
                    <nav>
                        <div class="nav nav-tabs" role="tablist"></div>
                    </nav>
                    <div class="tab-content"></div>
                </div>
            </div>

            <div class="container-fluid" id="fofinfo_bond_product">
                <div class="row justify-content-around">
                    <input type="text" class="form-control col-4" placeholder="关键词回车搜索，比如：增强、二级" id="bondProductSearch" onchange="filterBondProduct(this.value)">
                    <div class="input-group mb-3 col-6">
                        <div class="input-group-prepend"> <span class="input-group-text" id="bondProductSelectAddon">#</span> </div>
                        <select class="form-control" id="bondProductSelect" onchange="displayBondProductInfo(this.value)"></select>
                    </div>
                </div>
                <hr>
                <div class="row justify-content-start">
                    <div class="col">
                        <!-- 基金信息表 -->
                        <h4 style="text-align:center">基金信息</h4>
                        <!-- style="height: 400px; overflow-y: auto;" -->
                        <div id="bond_fund_info"> </div>
                    </div>
                </div><br>
                <div class="row justify-content-around">
                    <div class="col radar" id="bond_product_radar1"></div>
                    <div class="col radar" id="bond_product_radar2"></div>
                    <div class="col radar" id="bond_product_radar3"></div>

                </div><br><br>
                <div id="bondProductMulti">
                    <nav>
                        <div class="nav nav-tabs" role="tablist"></div>
                    </nav>
                    <div class="tab-content"></div>
                </div>
            </div>

            <div class="container-fluid" id="fofinfo_bond_manager">
                <div class="row justify-content-around">
                    <input type="text" class="form-control col-4" placeholder="关键词回车搜索，比如：王、女、博士、纯债" id="bondManagerSearch" onchange="filterBondManager(this.value)">
                    <div class="input-group mb-3 col-6">
                        <div class="input-group-prepend"> <span class="input-group-text" id="bondManagerSelectAddon">#</span> </div>
                        <select class="form-control " id="bondManagerSelect" onchange="displayBondManagerInfo(this.value)"></select>
                    </div>
                </div>
                <hr>
                <div class="row justify-content-start">
                    <div class="col">
                        <!-- 基金信息表 -->
                        <h4 style="text-align:center">基金经理信息</h4>
                        <div id="bondManagerProfile"></div>
                    </div>
                </div><br>
                <div class="row justify-content-around">
                    <div class="col radar" id="bond_manager_radar1"></div>
                    <div class="col radar" id="bond_manager_radar2"></div>
                    <div class="col radar" id="bond_manager_radar3"></div>
                </div><br><br>
                <div id="bondManagerMulti">
                    <nav>
                        <div class="nav nav-tabs" role="tablist"></div>
                    </nav>
                    <div class="tab-content"></div>
                </div>
            </div>

            <div class="container-fluid" id="fofinfo_portfolio_track">
                <div class="container-fluid">

                    <!-- 调仓频率与投资组合的选择 -->
                    <div class="row justify-content-around" id="fofinfo_portfolio_track_input">
                        <div class="input-group col-4">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="portfolio_select">基金组合</label>
                            </div>
                            <select class="form-control" id="portfolio_select">
                                <option value=1>组合一：偏股型基金组合（包含主题型基金）</option>
                                <option value=2>组合二：偏股型基金组合（剔除主题型基金）</option>
                                <option value=3>组合三：成长型基金组合（包含主题型基金）</option>
                                <option value=4>组合四：价值型基金组合（包含主题型基金)</option>
                            </select>
                        </div>
                        <div class="input-group col-4">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="tiaocangpinlv">调仓频率</label>
                            </div>
                            <select class="form-control" id="tiaocangpinlv">
                                <option value=3>季度</option>
                                <option value=6>半年</option>
                            </select>
                        </div>
                        <div class="input-group col-2">
                            <button type="button" class="btn btn-outline-warning" data-toggle="tooltip" data-placement="right" onclick="onPortSelect()">提取</button>
                        </div>
                    </div>
                    <small style="color:rgba(96,96,96,.934)">
                        组合说明: 1. 剔除非初始基金（A类C类等）、封闭式基金和分级基金；2.调仓时考虑不能赎回、不能申购的情况 3. 基金申购费率为1%%，赎回费为0.5%.
                    </small>
                    <hr>
                    <div class="row">
                        <div class="col-9">
                            <div class="row">
                                <div id="benchmarkLine" style="width:100%;height:300%"></div>
                            </div>
                            <br>
                            <div class="row">
                                <div id="benchmarkBar" style="width:100%;height:300%"></div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="container"><br>
                                <h4>组合绩效指标</h4>
                                <br>
                                <div class="table-responsive-lg" id="portGreeks"></div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="input-group mb-4 col-3">
                        <div class="input-group-prepend"><label class="input-group-text" for="recommDateSelect">选择推荐时间</label></div>
                        <select class="custom-select" id="fundRecommSelect"></select>
                    </div>
                    <h4 style="text-align:center;vertical-align:middle">基金推荐名单</h4><br>
                    <div style="text-align:center;vertical-align:middle"><small style="color:rgba(96,96,96,.934);">单击列名进行排序，按住Shift点击进行多列排序。</small></div>

                    <div class="tab-content" id="fundRecommTableMulti"></div>




                </div>
            </div>
        </div>
    </div>

    <!-- 界面：基金分析工具 -->
    <div class="container-fluid" id="updatelog_app">
        <div class="row">
            <div class="col-2"></div>

            <ul>

                <h5 style="color: #DAA620;">
                    V4.0.0 (2021年03月21日)
                </h5>
                <h6>正式版发布</h6><br>

                <h5 style="color: #DAA620;">
                    V4.0.1 (2021年04月06日)
                </h5>
                <h6>因子模块：修复了月数据滞后、负向因子月度多空收益计算出错的问题;</h6>
                <h6>FOF模块：修复了因为排名数据缺失导致整个界面无法刷新的问题;</h6>
                <br>
                <h5 style="color: #DAA620;">
                    V4.0.2 (2021年05月31日)
                </h5>
                <h6>FOF模块：修复了季度数据无法点击的问题；优先显示最新一期;</h6>
                <br>
                <h5 style="color: #DAA620;">
                    V4.0.3 (2021年06月07日)
                </h5>
                <h6>FOF模块：修复了组合净值日期不连续的问题;</h6>

            </ul>


        </div>



    </div>

    <br><br><br><br><br><br>
</body>

</html>